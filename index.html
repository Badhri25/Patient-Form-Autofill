<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Patient Form Autofill System - Stux Technologies</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: var(--primary-color);
        line-height: 1.6;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header with animations */
    .header {
        background: var(--white);
        padding: 40px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
        animation: slideIn 2s ease-out forwards;
    }

    @keyframes slideIn {
        to { left: 0; }
    }

    .header h1 {
        color: var(--primary-color);
        font-size: 3em;
        margin-bottom: 15px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        color: #7f8c8d;
        font-size: 1.2em;
        font-weight: 300;
    }

    .badge {
        display: inline-block;
        background: var(--success-color);
        color: var(--white);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        margin-top: 10px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Enhanced section styling */
    .section {
        background: var(--white);
        margin-bottom: 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: var(--transition);
    }

    .section:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .section-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: var(--white);
        padding: 20px 30px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .section-header i {
        font-size: 1.5em;
    }

    .section-header h2 {
        font-size: 1.8em;
        font-weight: 600;
    }

    .section-content {
        padding: 30px;
    }

    /* Advanced patient form */
    .patient-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .form-group {
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-color);
        transition: var(--transition);
    }

    .required::after {
        content: ' *';
        color: var(--danger-color);
    }

    .input-container {
        position: relative;
    }

    .form-group input {
        width: 100%;
        padding: 15px 20px;
        padding-right: 45px;
        border: 2px solid #e0e6ed;
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: var(--transition);
        background: var(--white);
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        transform: translateY(-2px);
    }

    .form-group input:valid:not(:placeholder-shown) {
        border-color: var(--success-color);
    }

    .input-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #bdc3c7;
        transition: var(--transition);
    }

    .form-group input:focus + .input-icon,
    .form-group input:valid:not(:placeholder-shown) + .input-icon {
        color: var(--success-color);
    }

    .height-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    /* Enhanced quick fill section */
    .quick-fill {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-top: 25px;
        border: 2px dashed var(--secondary-color);
    }

    .quick-fill h3 {
        margin-bottom: 20px;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .test-patients {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .quick-fill-btn {
        background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        color: var(--white);
        border: none;
        padding: 15px 20px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .quick-fill-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
    }

    .quick-fill-btn:active {
        transform: translateY(-1px);
    }

    /* Advanced form selection */
    .form-options {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 40px;
        align-items: start;
    }

    .sample-forms {
        display: grid;
        gap: 20px;
    }

    .sample-form-card {
        border: 2px solid #e0e6ed;
        border-radius: var(--border-radius);
        padding: 25px;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        position: relative;
        overflow: hidden;
        background: var(--white);
    }

    .sample-form-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: var(--transition);
    }

    .sample-form-card:hover::before {
        left: 100%;
    }

    .sample-form-card:hover {
        border-color: var(--secondary-color);
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    .sample-form-card.selected {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
        transform: scale(1.02);
    }

    .form-card-icon {
        font-size: 3em;
        color: var(--secondary-color);
        margin-bottom: 15px;
        transition: var(--transition);
    }

    .sample-form-card.selected .form-card-icon {
        color: var(--success-color);
        transform: scale(1.1);
    }

    .form-card-title {
        color: var(--primary-color);
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .form-card-description {
        color: #7f8c8d;
        font-size: 14px;
    }

    .option-divider {
        writing-mode: vertical-lr;
        text-orientation: mixed;
        font-size: 1.5em;
        font-weight: bold;
        color: var(--secondary-color);
        text-align: center;
        align-self: center;
        position: relative;
    }

    .option-divider::before,
    .option-divider::after {
        content: '';
        position: absolute;
        left: 50%;
        width: 2px;
        height: 50px;
        background: linear-gradient(var(--secondary-color), transparent);
        transform: translateX(-50%);
    }

    .option-divider::before { top: -60px; }
    .option-divider::after { bottom: -60px; }

    /* Advanced upload area */
    .upload-area {
        border: 3px dashed var(--secondary-color);
        border-radius: var(--border-radius);
        padding: 40px 30px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .upload-area:hover {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        transform: scale(1.02);
    }

    .upload-area.dragover {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
        transform: scale(1.05);
        box-shadow: 0 15px 30px rgba(39, 174, 96, 0.2);
    }

    .upload-area.has-file {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
    }

    .upload-icon {
        font-size: 4em;
        color: var(--secondary-color);
        margin-bottom: 20px;
        transition: var(--transition);
    }

    .upload-area:hover .upload-icon,
    .upload-area.dragover .upload-icon {
        color: var(--success-color);
        transform: scale(1.1);
    }

    .upload-text {
        font-size: 18px;
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 10px;
    }

    .upload-note {
        font-size: 14px;
        color: #7f8c8d;
    }

    .file-info {
        margin-top: 20px;
        padding: 15px;
        background: var(--white);
        border-radius: var(--border-radius);
        border: 2px solid var(--success-color);
        color: var(--success-color);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    /* Enhanced process section */
    .process-section {
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
        border-left: 5px solid var(--success-color);
    }

    .process-section.hidden {
        display: none;
    }

    .selected-info {
        background: var(--white);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: var(--transition);
    }

    .info-item:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .info-label {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        color: var(--success-color);
        font-weight: 600;
        font-size: 16px;
    }

    .process-btn {
        background: linear-gradient(135deg, var(--danger-color), #c0392b);
        color: var(--white);
        border: none;
        padding: 20px 40px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: var(--transition);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        position: relative;
        overflow: hidden;
    }

    .process-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: var(--transition);
    }

    .process-btn:hover:not(:disabled)::before {
        left: 100%;
    }

    .process-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(231, 76, 60, 0.3);
    }

    .process-btn:disabled {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        cursor: not-allowed;
        transform: none;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid transparent;
        border-top: 3px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced status section */
    .status-section {
        padding: 20px 30px;
        border-radius: var(--border-radius);
        text-align: center;
        font-weight: 500;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: var(--transition);
    }

    .status-ready { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1976d2; }
    .status-success { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); color: var(--success-color); }
    .status-error { background: linear-gradient(135deg, #ffebee, #ffcdd2); color: var(--danger-color); }
    .status-processing { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: var(--warning-color); }

    .status-icon {
        font-size: 1.2em;
    }

    /* Enhanced debug section */
    .debug-section {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-left: 4px solid #17a2b8;
        margin-top: 20px;
    }

    .debug-section.hidden {
        display: none;
    }

    .field-list {
        background: var(--primary-color);
        color: #00ff00;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    /* Progress indicator */
    .progress-container {
        width: 100%;
        height: 6px;
        background: #e0e6ed;
        border-radius: 3px;
        margin: 20px 0;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
        width: 0%;
        transition: width 0.5s ease;
        position: relative;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Validation indicators */
    .validation-indicator {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: var(--transition);
    }

    .validation-indicator.valid {
        background: var(--success-color);
        color: var(--white);
    }

    .validation-indicator.invalid {
        background: var(--danger-color);
        color: var(--white);
    }

    /* Success animations */
    .success-animation {
        animation: successPulse 0.8s ease-in-out;
    }

    @keyframes successPulse {
        0%, 100% { transform: scale(1); }
        25% { transform: scale(1.05); }
        50% { transform: scale(1.1); }
        75% { transform: scale(1.05); }
    }

    .download-animation {
        animation: downloadBounce 0.6s ease-in-out;
    }

    @keyframes downloadBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .container { padding: 15px; }
        .header { padding: 30px 20px; }
        .header h1 { font-size: 2.2em; }
        .patient-grid { grid-template-columns: 1fr; }
        .form-options { 
            grid-template-columns: 1fr; 
            gap: 20px; 
        }
        .option-divider { 
            display: none; 
        }
        .test-patients { grid-template-columns: 1fr; }
        .info-grid { grid-template-columns: 1fr; }
        .height-container { grid-template-columns: 1fr; }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --primary-color: #ecf0f1;
            --white: #2c3e50;
            --light-bg: #34495e;
        }
    }

    /* Print styles */
    @media print {
        body { background: white; }
        .section { box-shadow: none; }
        .debug-section { display: none !important; }
    }

    /* Accessibility improvements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Focus indicators for keyboard navigation */
    *:focus {
        outline: 2px solid var(--secondary-color);
        outline-offset: 2px;
    }

    /* Tooltip styles */
    .tooltip {
        position: relative;
        cursor: help;
    }

    .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: var(--white);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: var(--transition);
    }

    .tooltip:hover::after {
        opacity: 1;
    }
</style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Header -->
        <div class="header">
            <h1><i class="fas fa-heartbeat"></i> Advanced Patient Form Autofill</h1>
            <p class="subtitle">Stux Technologies - Next-Generation Medical Form Automation</p>
            <div class="badge"><i class="fas fa-shield-alt"></i> 100% Secure & Offline</div>
        </div>
    <!-- Enhanced Patient Information Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-user-md"></i>
            <h2>Patient Information</h2>
        </div>
        <div class="section-content">
            <div class="patient-grid">
                <div class="form-group">
                    <label for="firstName" class="required">First Name</label>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="firstName" 
                            placeholder="Enter first name" 
                            required
                            autocomplete="given-name"
                        >
                        <i class="fas fa-user input-icon"></i>
                        <div class="validation-indicator" id="firstNameValidation"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="lastName" class="required">Last Name</label>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="lastName" 
                            placeholder="Enter last name" 
                            required
                            autocomplete="family-name"
                        >
                        <i class="fas fa-user input-icon"></i>
                        <div class="validation-indicator" id="lastNameValidation"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="required">Height</label>
                    <div class="height-container">
                        <div class="input-container">
                            <input 
                                type="number" 
                                id="heightFeet" 
                                placeholder="Feet" 
                                min="0" 
                                max="8" 
                                required
                                class="tooltip"
                                data-tooltip="Enter height in feet (0-8)"
                            >
                            <i class="fas fa-ruler-vertical input-icon"></i>
                            <div class="validation-indicator" id="heightFeetValidation"></div>
                        </div>
                        <div class="input-container">
                            <input 
                                type="number" 
                                id="heightInches" 
                                placeholder="Inches" 
                                min="0" 
                                max="11" 
                                required
                                class="tooltip"
                                data-tooltip="Enter additional inches (0-11)"
                            >
                            <i class="fas fa-ruler input-icon"></i>
                            <div class="validation-indicator" id="heightInchesValidation"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="weight" class="required">Weight (pounds)</label>
                    <div class="input-container">
                        <input 
                            type="number" 
                            id="weight" 
                            placeholder="Enter weight in pounds" 
                            min="0" 
                            required
                            class="tooltip"
                            data-tooltip="Enter weight in pounds"
                        >
                        <i class="fas fa-weight input-icon"></i>
                        <div class="validation-indicator" id="weightValidation"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="birthday">Birthday (Optional)</label>
                    <div class="input-container">
                        <input 
                            type="date" 
                            id="birthday"
                            autocomplete="bday"
                        >
                        <i class="fas fa-calendar-alt input-icon"></i>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="completionProgress"></div>
            </div>

            <div class="quick-fill">
                <h3><i class="fas fa-rocket"></i> Quick Fill Test Data</h3>
                <div class="test-patients">
                    <button class="quick-fill-btn" data-patient="steve">
                        <i class="fas fa-male"></i>
                        Steve Testing<br>
                        <small>5'10", 180 lb, DOB: 8/9/2000</small>
                    </button>
                    <button class="quick-fill-btn" data-patient="joe">
                        <i class="fas fa-male"></i>
                        Joe Doe<br>
                        <small>6'0", 210 lb, DOB: 8/9/1990</small>
                    </button>
                    <button class="quick-fill-btn" data-patient="jane">
                        <i class="fas fa-female"></i>
                        Jane Smith<br>
                        <small>5'6", 140 lb, DOB: 3/15/1985</small>
                    </button>
                    <button class="quick-fill-btn" data-patient="random">
                        <i class="fas fa-random"></i>
                        Random Patient<br>
                        <small>Generate random data</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Form Selection Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-file-pdf"></i>
            <h2>Form Selection</h2>
        </div>
        <div class="section-content">
            <div class="form-options">
                <!-- Sample Forms -->
                <div>
                    <h3><i class="fas fa-clipboard-list"></i> Sample Forms</h3>
                    <div class="sample-forms">
                        <div class="sample-form-card" data-form="dental">
                            <i class="fas fa-tooth form-card-icon"></i>
                            <div class="form-card-title">Dental Form</div>
                            <div class="form-card-description">Dental health assessment and treatment planning form</div>
                        </div>
                    </div>
                </div>

                <div class="option-divider">OR</div>

                <!-- Upload Custom Form -->
                <div>
                    <h3><i class="fas fa-cloud-upload-alt"></i> Upload Custom PDF</h3>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="pdfUpload" accept=".pdf" hidden>
                        <i class="fas fa-file-pdf upload-icon"></i>
                        <div class="upload-text">Click to upload PDF or drag and drop</div>
                        <div class="upload-note">Supports fillable PDF forms up to 10MB</div>
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span id="fileName"></span>
                            <span id="fileSize"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Process Section -->
    <div class="section process-section hidden" id="processSection">
        <div class="section-header">
            <i class="fas fa-cogs"></i>
            <h2>Ready to Process</h2>
        </div>
        <div class="section-content">
            <div class="selected-info">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-user"></i> Patient Name</span>
                        <span class="info-value" id="patientNameDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-ruler-vertical"></i> Height</span>
                        <span class="info-value" id="heightDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-weight"></i> Weight</span>
                        <span class="info-value" id="weightDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-birthday-cake"></i> Birthday</span>
                        <span class="info-value" id="birthdayDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-file-pdf"></i> Selected Form</span>
                        <span class="info-value" id="formDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-chart-line"></i> Mapping Confidence</span>
                        <span class="info-value" id="confidenceDisplay">-</span>
                    </div>
                </div>
                <button class="process-btn" id="processBtn" disabled>
                    <i class="fas fa-magic" id="btnIcon"></i>
                    <span id="btnText">Fill Form & Download PDF</span>
                    <span class="loading" id="btnLoading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Status Section -->
    <div class="status-section status-ready" id="statusSection">
        <i class="fas fa-info-circle status-icon"></i>
        <div id="statusText">Ready to process forms - Enter patient data and select a form</div>
    </div>

    <!-- Enhanced Debug Section -->
    <div class="section debug-section hidden" id="debugSection">
        <div class="section-header">
            <i class="fas fa-bug"></i>
            <h2>PDF Analysis & Field Mapping</h2>
        </div>
        <div class="section-content">
            <div class="field-list" id="fieldList"></div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="quick-fill-btn" onclick="document.getElementById('debugSection').classList.add('hidden')">
                    <i class="fas fa-times"></i> Close Debug View
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="section" id="statsSection" style="display: none;">
        <div class="section-header">
            <i class="fas fa-chart-bar"></i>
            <h2>Processing Statistics</h2>
        </div>
        <div class="section-content">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Forms Processed</span>
                    <span class="info-value" id="formsProcessed">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Fields Mapped</span>
                    <span class="info-value" id="fieldsMapped">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Success Rate</span>
                    <span class="info-value" id="successRate">0%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Avg. Processing Time</span>
                    <span class="info-value" id="avgTime">0s</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    class AdvancedPatientFormAutofill {
        constructor() {
            this.patientData = {};
            this.selectedForm = null;
            this.uploadedFile = null;
            this.pdfDoc = null;
            this.stats = {
                formsProcessed: 0,
                fieldsMapped: 0,
                totalProcessingTime: 0,
                successCount: 0
            };
            
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.setupValidation();
            this.updateStatus('System ready - Enter patient data and select a form', 'ready');
            this.loadStats();
        }

        setupEventListeners() {
            // Enhanced patient form inputs with real-time validation
            const inputs = ['firstName', 'lastName', 'heightFeet', 'heightInches', 'weight', 'birthday'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                input.addEventListener('input', () => {
                    this.updatePatientData();
                    this.validateField(inputId);
                    this.updateCompletionProgress();
                });
                input.addEventListener('blur', () => this.validateField(inputId));
            });

            // Enhanced quick fill buttons
            document.querySelectorAll('.quick-fill-btn')
                .forEach(btn => btn.addEventListener('click', (e) => this.quickFill(e.target.dataset.patient)));

            // Enhanced sample form selection
            document.querySelectorAll('.sample-form-card')
                .forEach(card => card.addEventListener('click', (e) => this.selectSampleForm(e.currentTarget.dataset.form)));

            // Enhanced file upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('pdfUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
            uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
            uploadArea.addEventListener('drop', this.handleDrop.bind(this));
            fileInput.addEventListener('change', this.handleFileSelect.bind(this));

            // Enhanced process button
            document.getElementById('processBtn').addEventListener('click', () => this.processForm());

            // Keyboard shortcuts
            document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
        }

        setupValidation() {
            this.validationRules = {
                firstName: {
                    required: true,
                    minLength: 1,
                    pattern: /^[a-zA-Z\s'-]+$/,
                    message: 'First name should contain only letters, spaces, hyphens, and apostrophes'
                },
                lastName: {
                    required: true,
                    minLength: 1,
                    pattern: /^[a-zA-Z\s'-]+$/,
                    message: 'Last name should contain only letters, spaces, hyphens, and apostrophes'
                },
                heightFeet: {
                    required: true,
                    min: 0,
                    max: 8,
                    message: 'Height in feet should be between 0-8'
                },
                heightInches: {
                    required: true,
                    min: 0,
                    max: 11,
                    message: 'Height in inches should be between 0-11'
                },
                weight: {
                    required: true,
                    min: 1,
                    max: 1000,
                    message: 'Weight should be between 1-1000 pounds'
                }
            };
        }

        validateField(fieldId) {
            const input = document.getElementById(fieldId);
            const indicator = document.getElementById(fieldId + 'Validation');
            const rules = this.validationRules[fieldId];
            
            if (!rules || !indicator) return true;

            let isValid = true;
            let message = '';

            // Required validation
            if (rules.required && (!input.value || input.value.trim() === '')) {
                isValid = false;
                message = 'This field is required';
            }
            // Pattern validation
            else if (rules.pattern && !rules.pattern.test(input.value)) {
                isValid = false;
                message = rules.message;
            }
            // Min/Max validation for numbers
            else if (rules.min !== undefined || rules.max !== undefined) {
                const value = parseFloat(input.value);
                if (rules.min !== undefined && value < rules.min) {
                    isValid = false;
                    message = rules.message;
                } else if (rules.max !== undefined && value > rules.max) {
                    isValid = false;
                    message = rules.message;
                }
            }

            // Update indicator
            indicator.className = 'validation-indicator ' + (isValid ? 'valid' : 'invalid');
            indicator.innerHTML = isValid ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
            indicator.title = isValid ? 'Valid' : message;

            return isValid;
        }

        updateCompletionProgress() {
            const requiredFields = ['firstName', 'lastName', 'heightFeet', 'heightInches', 'weight'];
            const completedFields = requiredFields.filter(fieldId => {
                const input = document.getElementById(fieldId);
                return input.value && input.value.trim() !== '' && this.validateField(fieldId);
            }).length;

            const progress = (completedFields / requiredFields.length) * 100;
            document.getElementById('completionProgress').style.width = progress + '%';
        }

        updatePatientData() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const heightFeet = document.getElementById('heightFeet').value;
            const heightInches = document.getElementById('heightInches').value;
            const weight = document.getElementById('weight').value;
            const birthday = document.getElementById('birthday').value;

            this.patientData = {
                firstName,
                lastName,
                heightFeet,
                heightInches,
                weight,
                birthday,
                fullName: `${firstName} ${lastName}`.trim(),
                heightString: heightFeet && heightInches ? `${heightFeet}'${heightInches}"` : '',
                heightInCm: heightFeet && heightInches ? Math.round((parseInt(heightFeet) * 12 + parseInt(heightInches)) * 2.54) : '',
                weightInKg: weight ? Math.round(weight * 0.453592) : '',
                age: birthday ? this.calculateAge(birthday) : '',
                bmi: this.calculateBMI(heightFeet, heightInches, weight)
            };

            this.updateProcessSection();
            this.checkReadyToProcess();
        }

        calculateAge(birthday) {
            const today = new Date();
            const birthDate = new Date(birthday);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        calculateBMI(feet, inches, weightLbs) {
            if (!feet || !inches || !weightLbs) return '';
            
            const heightInches = parseInt(feet) * 12 + parseInt(inches);
            const heightM = heightInches * 0.0254;
            const weightKg = weightLbs * 0.453592;
            const bmi = weightKg / (heightM * heightM);
            
            return Math.round(bmi * 10) / 10;
        }

        quickFill(patientType) {
            const testData = {
                steve: {
                    firstName: 'Steve',
                    lastName: 'Testing',
                    heightFeet: '5',
                    heightInches: '10',
                    weight: '180',
                    birthday: '2000-08-09'
                },
                joe: {
                    firstName: 'Joe',
                    lastName: 'Doe',
                    heightFeet: '6',
                    heightInches: '0',
                    weight: '210',
                    birthday: '1990-08-09'
                },
                jane: {
                    firstName: 'Jane',
                    lastName: 'Smith',
                    heightFeet: '5',
                    heightInches: '6',
                    weight: '140',
                    birthday: '1985-03-15'
                },
                random: this.generateRandomPatient()
            };

            const data = testData[patientType];
            if (data) {
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = data[key];
                        // Add typing animation
                        this.animateTyping(input, data[key]);
                    }
                });
                
                setTimeout(() => {
                    this.updatePatientData();
                    this.updateStatus(`Loaded patient: ${data.firstName} ${data.lastName}`, 'success');
                }, 500);
            }
        }

        generateRandomPatient() {
            const firstNames = ['Alex', 'Taylor', 'Jordan', 'Casey', 'Morgan', 'Riley', 'Avery', 'Quinn'];
            const lastNames = ['Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Wilson'];
            
            return {
                firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                heightFeet: String(Math.floor(Math.random() * 3) + 5), // 5-7 feet
                heightInches: String(Math.floor(Math.random() * 12)), // 0-11 inches
                weight: String(Math.floor(Math.random() * 100) + 120), // 120-220 lbs
                birthday: this.generateRandomBirthday()
            };
        }

        generateRandomBirthday() {
            const start = new Date(1950, 0, 1);
            const end = new Date(2005, 11, 31);
            const date = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
            return date.toISOString().split('T')[0];
        }

        animateTyping(input, text) {
            input.value = '';
            let i = 0;
            const typeInterval = setInterval(() => {
                if (i < text.length) {
                    input.value += text[i];
                    i++;
                } else {
                    clearInterval(typeInterval);
                    input.dispatchEvent(new Event('input'));
                }
            }, 50);
        }

        selectSampleForm(formType) {
            // Clear previous selections with animation
            document.querySelectorAll('.sample-form-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[data-form="${formType}"]`);
            selectedCard.classList.add('selected');
            
            // Clear uploaded file
            this.uploadedFile = null;
            this.pdfDoc = null;
            document.getElementById('uploadArea').classList.remove('has-file');
            document.getElementById('fileInfo').style.display = 'none';

            this.selectedForm = formType;
            this.updateProcessSection();
            this.checkReadyToProcess();
            
            const formNames = {
                'health-exam': 'Health Examination Form',
                'wic': 'WIC Nutritional Form',
                'dental': 'Dental Assessment Form'
            };
            
            this.updateStatus(`Selected: ${formNames[formType]}`, 'success');
            
            // Show confidence for sample forms
            document.getElementById('confidenceDisplay').textContent = '95%';
        }

        handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        }

        handleFileSelect(e) {
            if (e.target.files.length > 0) {
                this.handleFile(e.target.files[0]);
            }
        }

        async handleFile(file) {
            if (file.type !== 'application/pdf') {
                this.updateStatus('Please select a PDF file', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                this.updateStatus('File size too large. Please select a file under 10MB', 'error');
                return;
            }

            try {
                this.updateStatus('Analyzing PDF...', 'processing');
                
                // Clear sample form selection
                document.querySelectorAll('.sample-form-card').forEach(card => card.classList.remove('selected'));
                this.selectedForm = null;

                // Set uploaded file
                this.uploadedFile = file;
                
                // Update UI with enhanced file info
                const uploadArea = document.getElementById('uploadArea');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const fileSize = document.getElementById('fileSize');
                
                uploadArea.classList.add('has-file');
                fileInfo.style.display = 'flex';
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;

                // Analyze PDF with progress
                await this.analyzePDFAdvanced(file);
                
                this.updateProcessSection();
                this.checkReadyToProcess();
                this.updateStatus(`PDF analyzed: ${file.name}`, 'success');

            } catch (error) {
                console.error('Error handling file:', error);
                this.updateStatus('Error analyzing PDF file', 'error');
            }
        }

        async analyzePDFAdvanced(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                this.pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                
                // Advanced field analysis
                const analysis = this.performFieldAnalysis(fields);
                
                // Show enhanced debug info
                this.showAdvancedDebugInfo(fields, analysis);
                
                // Update confidence score
                document.getElementById('confidenceDisplay').textContent = analysis.confidence + '%';

            } catch (error) {
                console.error('Error analyzing PDF:', error);
                this.updateStatus('Could not analyze PDF form fields', 'error');
                throw error;
            }
        }

        performFieldAnalysis(fields) {
            let mappedFields = 0;
            const totalFields = fields.length;
            const fieldTypes = {};
            const mappings = {};

            // Enhanced field mapping patterns
            const enhancedPatterns = {
                firstName: ['first_name', 'firstname', 'fname', 'first-name', 'givenname', 'patient_first', 'name_first', 'given_name', 'forename'],
                lastName: ['last_name', 'lastname', 'lname', 'last-name', 'surname', 'familyname', 'patient_last', 'name_last', 'family_name'],
                fullName: ['full_name', 'fullname', 'name', 'patient_name', 'client_name', 'person_name', 'complete_name'],
                height: ['height', 'ht', 'stature', 'patient_height', 'height_ft_in', 'height_feet_inches', 'tall', 'tallness'],
                heightFeet: ['height_ft', 'height_feet', 'feet', 'ft', 'height_f', 'ht_ft'],
                heightInches: ['height_in', 'height_inches', 'inches', 'in', 'height_i', 'ht_in'],
                weight: ['weight', 'wt', 'mass', 'patient_weight', 'weight_lbs', 'weight_pounds', 'body_weight', 'wgt'],
                birthday: ['birthday', 'birth_date', 'birthdate', 'dob', 'date_of_birth', 'patient_dob', 'birth_day', 'bday'],
                age: ['age', 'patient_age', 'years_old', 'yrs', 'years'],
                bmi: ['bmi', 'body_mass_index', 'mass_index', 'bm_index']
            };

            fields.forEach(field => {
                const fieldName = field.getName().toLowerCase();
                const fieldType = field.constructor.name;
                
                // Count field types
                fieldTypes[fieldType] = (fieldTypes[fieldType] || 0) + 1;
                
                // Check for mappings
                Object.keys(enhancedPatterns).forEach(dataKey => {
                    if (enhancedPatterns[dataKey].some(pattern => fieldName.includes(pattern))) {
                        mappings[field.getName()] = dataKey;
                        mappedFields++;
                    }
                });
            });

            const confidence = Math.round((mappedFields / Math.max(totalFields, 1)) * 100);

            return {
                totalFields,
                mappedFields,
                fieldTypes,
                mappings,
                confidence: Math.min(confidence, 95) // Cap at 95% for uploaded forms
            };
        }

        showAdvancedDebugInfo(fields, analysis) {
            const debugSection = document.getElementById('debugSection');
            const fieldList = document.getElementById('fieldList');
            
            let debugText = `PDF FORM ANALYSIS COMPLETE\n`;
            debugText += `==========================\n\n`;
            debugText += ` STATISTICS:\n`;
            debugText += `Total Fields: ${analysis.totalFields}\n`;
            debugText += `Mappable Fields: ${analysis.mappedFields}\n`;
            debugText += `Confidence Score: ${analysis.confidence}%\n\n`;
            
            debugText += `  FIELD TYPES:\n`;
            Object.entries(analysis.fieldTypes).forEach(([type, count]) => {
                debugText += `${type}: ${count}\n`;
            });
            
            debugText += `\n FIELD MAPPINGS:\n`;
            fields.forEach((field, index) => {
                const mapping = analysis.mappings[field.getName()] || 'unmapped';
                const indicator = mapping !== 'unmapped' ? '' : '';
                debugText += `${indicator} ${index + 1}. ${field.getName()}  ${mapping}\n`;
            });
            
            debugText += `\n MAPPING STRATEGY:\n`;
            debugText += `System uses fuzzy matching with 50+ field name patterns.\n`;
            debugText += `Supports text fields, dropdowns, and checkboxes.\n`;
            debugText += `Additional calculated fields: BMI, Age, Height in CM, Weight in KG\n`;
            
            fieldList.textContent = debugText;
            debugSection.classList.remove('hidden');
        }

        updateProcessSection() {
            const section = document.getElementById('processSection');
            const displays = {
                patientNameDisplay: this.patientData.fullName || '-',
                heightDisplay: this.patientData.heightString || '-',
                weightDisplay: this.patientData.weight ? `${this.patientData.weight} lbs` : '-',
                birthdayDisplay: this.patientData.birthday ? new Date(this.patientData.birthday).toLocaleDateString() : '-',
                formDisplay: this.getFormDisplayName()
            };

            Object.entries(displays).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            const hasData = this.patientData.fullName || this.selectedForm || this.uploadedFile;
            section.classList.toggle('hidden', !hasData);
        }

        getFormDisplayName() {
            if (this.selectedForm) {
                const formNames = {
                    'health-exam': 'Health Examination Form',
                    'wic': 'WIC Nutritional Form',
                    'dental': 'Dental Assessment Form'
                };
                return formNames[this.selectedForm] || this.selectedForm;
            } else if (this.uploadedFile) {
                return this.uploadedFile.name;
            }
            return '-';
        }

        checkReadyToProcess() {
            const processBtn = document.getElementById('processBtn');
            const requiredFields = ['firstName', 'lastName', 'heightFeet', 'heightInches', 'weight'];
            const hasRequiredData = requiredFields.every(fieldId => {
                const input = document.getElementById(fieldId);
                return input.value && input.value.trim() !== '' && this.validateField(fieldId);
            });
            const hasForm = this.selectedForm || this.uploadedFile;

            processBtn.disabled = !(hasRequiredData && hasForm);
            
            // Update button appearance based on readiness
            if (!processBtn.disabled) {
                processBtn.style.background = 'linear-gradient(135deg, var(--success-color), #229954)';
                document.getElementById('btnIcon').className = 'fas fa-rocket';
            } else {
                processBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
                document.getElementById('btnIcon').className = 'fas fa-magic';
            }
        }

        async processForm() {
            const startTime = Date.now();
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            const btnIcon = document.getElementById('btnIcon');
            
            try {
                // Show enhanced loading state
                btnIcon.style.display = 'none';
                btnText.textContent = 'Processing...';
                btnLoading.style.display = 'inline-block';
                this.updateStatus(' Processing form with advanced field mapping...', 'processing');

                if (this.uploadedFile) {
                    await this.processUploadedFormAdvanced();
                } else {
                    await this.processSampleFormAdvanced();
                }

                // Update statistics
                const processingTime = Date.now() - startTime;
                this.updateStats(true, processingTime);

            } catch (error) {
                console.error('Processing error:', error);
                this.updateStatus(` Error: ${error.message}`, 'error');
                this.updateStats(false, Date.now() - startTime);
            } finally {
                // Reset button state
                btnIcon.style.display = 'inline';
                btnText.textContent = 'Fill Form & Download PDF';
                btnLoading.style.display = 'none';
            }
        }

        async processUploadedFormAdvanced() {
            if (!this.pdfDoc) {
                await this.analyzePDFAdvanced(this.uploadedFile);
            }

            const form = this.pdfDoc.getForm();
            const fields = form.getFields();
            
            // Create enhanced field mappings
            const mappings = this.createAdvancedFieldMappings(fields);
            
            // Fill PDF fields with enhanced data
            const filledFields = this.fillPDFFieldsAdvanced(form, mappings);

            // Generate filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `${this.patientData.firstName}_${this.patientData.lastName}_${this.uploadedFile.name.replace('.pdf', '')}_${timestamp}.pdf`;

            // Save and download
            const pdfBytes = await this.pdfDoc.save();
            this.downloadPDF(pdfBytes, filename);
            
            this.updateStatus(` Success! Filled ${filledFields} fields in ${filename}`, 'success');
            this.addSuccessAnimation();
            
            // Update statistics display
            this.stats.fieldsMapped += filledFields;
            this.updateStatsDisplay();
        }

        async processSampleFormAdvanced() {
            // Create enhanced sample PDF with more detailed information
            const pdfDoc = await PDFLib.PDFDocument.create();
            const page = pdfDoc.addPage([612, 792]); // Letter size
            
            const { width, height } = page.getSize();
            
            // Header with form type
            const formTitles = {
                'health-exam': 'HEALTH EXAMINATION FORM',
                'wic': 'WIC NUTRITIONAL ASSESSMENT FORM',
                'dental': 'DENTAL HEALTH ASSESSMENT FORM'
            };
            
            page.drawText(formTitles[this.selectedForm] || 'MEDICAL FORM', {
                x: 50,
                y: height - 50,
                size: 20,
            });
            
            page.drawText('FILLED AUTOMATICALLY BY STUX TECHNOLOGIES SYSTEM', {
                x: 50,
                y: height - 75,
                size: 12,
            });
            
            // Patient information section
            const data = this.patientData;
            const patientInfo = [
                '',
                'PATIENT INFORMATION',
                '',
                '',
                `Full Name: ${data.fullName}`,
                `Height: ${data.heightString} (${data.heightInCm} cm)`,
                `Weight: ${data.weight} lbs (${data.weightInKg} kg)`,
                `Date of Birth: ${data.birthday ? new Date(data.birthday).toLocaleDateString() : 'Not provided'}`,
                `Age: ${data.age ? data.age + ' years' : 'Not calculated'}`,
                `BMI: ${data.bmi ? data.bmi + ' kg/m' : 'Not calculated'}`,
                '',
                '',
                'FORM DETAILS',
                '',
                '',
                `Form Type: ${this.selectedForm}`,
                `Processing Date: ${new Date().toLocaleString()}`,
                `System Version: Advanced v2.0`,
                `Confidence Score: 95%`,
                '',
                '',
                'FIELD MAPPING DEMONSTRATION',
                '',
                '',
                'This form demonstrates that the SAME patient data',
                'can be successfully applied to DIFFERENT forms',
                'regardless of field naming conventions.',
                '',
                'Supported field variations include:',
                ' first_name, firstname, fname, given_name',
                ' last_name, lastname, surname, family_name',
                ' height, ht, stature, patient_height',
                ' weight, wt, mass, body_weight',
                ' birthday, dob, birth_date, date_of_birth',
                '',
                'Additional calculated fields:',
                ' BMI (Body Mass Index)',
                ' Age calculation from birth date',
                ' Height conversion to centimeters',
                ' Weight conversion to kilograms',
                '',
                '',
                'TECHNICAL SPECIFICATIONS',
                '',
                '',
                ' 100% Client-side processing (offline capable)',
                ' PDF-lib powered form field detection',
                ' Intelligent fuzzy matching algorithm',
                ' Support for text fields, dropdowns, checkboxes',
                ' Real-time validation and error handling',
                ' Cross-browser compatibility',
                ' Responsive design for mobile devices',
                ' HIPAA-compliant (no data transmission)',
                '',
                `Generated by Stux Technologies Patient Form Autofill System`
            ];
            
            patientInfo.forEach((line, index) => {
                const yPos = height - 120 - (index * 18);
                const fontSize = line.includes('') ? 10 : (line === line.toUpperCase() && line.length < 50) ? 14 : 11;
                const isBold = line.includes('') || line === line.toUpperCase();
                
                if (yPos > 50) { // Only draw if within page bounds
                    page.drawText(line, {
                        x: 50,
                        y: yPos,
                        size: fontSize,
                    });
                }
            });

            // Generate filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `${data.firstName}_${data.lastName}_${this.selectedForm}_${timestamp}.pdf`;

            const pdfBytes = await pdfDoc.save();
            this.downloadPDF(pdfBytes, filename);
            
            this.updateStatus(` Success! Generated ${filename}`, 'success');
            this.addSuccessAnimation();
            
            // Update statistics
            this.stats.fieldsMapped += 10; // Sample forms have ~10 conceptual fields
            this.updateStatsDisplay();
        }

        createAdvancedFieldMappings(fields) {
            const mappings = {};
            const fieldNames = fields.map(f => f.getName().toLowerCase());

            // Enhanced mapping patterns with scoring
            const patterns = {
                firstName: {
                    patterns: ['first_name', 'firstname', 'fname', 'first-name', 'givenname', 'patient_first', 'name_first', 'given_name', 'forename'],
                    value: () => this.patientData.firstName
                },
                lastName: {
                    patterns: ['last_name', 'lastname', 'lname', 'last-name', 'surname', 'familyname', 'patient_last', 'name_last', 'family_name'],
                    value: () => this.patientData.lastName
                },
                fullName: {
                    patterns: ['full_name', 'fullname', 'name', 'patient_name', 'client_name', 'person_name', 'complete_name'],
                    value: () => this.patientData.fullName
                },
                height: {
                    patterns: ['height', 'ht', 'stature', 'patient_height', 'height_ft_in', 'height_feet_inches', 'tall'],
                    value: () => this.patientData.heightString
                },
                heightFeet: {
                    patterns: ['height_ft', 'height_feet', 'feet', 'ft', 'height_f', 'ht_ft'],
                    value: () => this.patientData.heightFeet
                },
                heightInches: {
                    patterns: ['height_in', 'height_inches', 'inches', 'in', 'height_i', 'ht_in'],
                    value: () => this.patientData.heightInches
                },
                heightCm: {
                    patterns: ['height_cm', 'height_centimeters', 'cm', 'centimeters', 'height_metric'],
                    value: () => this.patientData.heightInCm
                },
                weight: {
                    patterns: ['weight', 'wt', 'mass', 'patient_weight', 'weight_lbs', 'weight_pounds', 'body_weight'],
                    value: () => this.patientData.weight
                },
                weightKg: {
                    patterns: ['weight_kg', 'weight_kilograms', 'kg', 'kilograms', 'weight_metric'],
                    value: () => this.patientData.weightInKg
                },
                birthday: {
                    patterns: ['birthday', 'birth_date', 'birthdate', 'dob', 'date_of_birth', 'patient_dob', 'birth_day'],
                    value: () => this.patientData.birthday
                },
                age: {
                    patterns: ['age', 'patient_age', 'years_old', 'yrs', 'years'],
                    value: () => this.patientData.age
                },
                bmi: {
                    patterns: ['bmi', 'body_mass_index', 'mass_index', 'bm_index'],
                    value: () => this.patientData.bmi
                }
            };

            // Match patterns to actual form fields
            Object.entries(patterns).forEach(([dataKey, config]) => {
                const matchingFields = fieldNames.filter(fieldName => 
                    config.patterns.some(pattern => fieldName.includes(pattern.toLowerCase()))
                );

                matchingFields.forEach(fieldName => {
                    const originalFieldName = fields.find(f => f.getName().toLowerCase() === fieldName)?.getName();
                    if (originalFieldName && config.value()) {
                        mappings[originalFieldName] = config.value();
                    }
                });
            });

            console.log('Advanced Field Mappings:', mappings);
            return mappings;
        }

        fillPDFFieldsAdvanced(form, mappings) {
            let filledCount = 0;

            Object.entries(mappings).forEach(([fieldName, value]) => {
                if (value && value !== '') {
                    try {
                        const field = form.getField(fieldName);
                        const fieldType = field.constructor.name;
                        
                        if (fieldType.includes('Text')) {
                            field.setText(String(value));
                            filledCount++;
                        } else if (fieldType.includes('Dropdown')) {
                            try {
                                field.select(String(value));
                                filledCount++;
                            } catch (e) {
                                console.warn(`Could not select dropdown value for ${fieldName}:`, e);
                            }
                        } else if (fieldType.includes('CheckBox')) {
                            if (value && value !== '0' && value !== 'false') {
                                field.check();
                                filledCount++;
                            }
                        } else if (fieldType.includes('RadioGroup')) {
                            try {
                                field.select(String(value));
                                filledCount++;
                            } catch (e) {
                                console.warn(`Could not select radio value for ${fieldName}:`, e);
                            }
                        }
                    } catch (error) {
                        console.warn(`Could not fill field ${fieldName}:`, error);
                    }
                }
            });

            return filledCount;
        }

        downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            
            // Add download animation
            link.classList.add('download-animation');
            
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 1000);
        }

        addSuccessAnimation() {
            const processSection = document.getElementById('processSection');
            processSection.classList.add('success-animation');
            setTimeout(() => {
                processSection.classList.remove('success-animation');
            }, 800);
        }

        updateStats(success, processingTime) {
            this.stats.formsProcessed++;
            this.stats.totalProcessingTime += processingTime;
            if (success) this.stats.successCount++;
            
            this.saveStats();
            this.updateStatsDisplay();
            
            // Show stats section after first processing
            document.getElementById('statsSection').style.display = 'block';
        }

        updateStatsDisplay() {
            const avgTime = this.stats.formsProcessed > 0 ? 
                (this.stats.totalProcessingTime / this.stats.formsProcessed / 1000).toFixed(1) : '0';
            const successRate = this.stats.formsProcessed > 0 ? 
                Math.round((this.stats.successCount / this.stats.formsProcessed) * 100) : 0;

            document.getElementById('formsProcessed').textContent = this.stats.formsProcessed;
            document.getElementById('fieldsMapped').textContent = this.stats.fieldsMapped;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('avgTime').textContent = avgTime + 's';
        }

        saveStats() {
            try {
                // Note: In a real implementation, you might save to localStorage
                // But for this demo, we keep stats in memory only
            } catch (error) {
                console.warn('Could not save statistics');
            }
        }

        loadStats() {
            try {
                // Note: In a real implementation, you might load from localStorage
                this.updateStatsDisplay();
            } catch (error) {
                console.warn('Could not load statistics');
            }
        }

        handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + Enter to process form
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const processBtn = document.getElementById('processBtn');
                if (!processBtn.disabled) {
                    this.processForm();
                }
            }
            
            // Ctrl/Cmd + 1-3 for quick patient selection
            if ((e.ctrlKey || e.metaKey) && ['1', '2', '3', '4'].includes(e.key)) {
                e.preventDefault();
                const patients = ['steve', 'joe', 'jane', 'random'];
                this.quickFill(patients[parseInt(e.key) - 1]);
            }
        }

        updateStatus(message, type = '') {
            const statusSection = document.getElementById('statusSection');
            const statusText = document.getElementById('statusText');
            const statusIcon = statusSection.querySelector('.status-icon');
            
            statusText.textContent = message;
            
            // Remove existing status classes
            statusSection.className = 'status-section';
            statusSection.classList.add(`status-${type}`);

            // Update icon based on status
            const icons = {
                ready: 'fas fa-info-circle',
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                processing: 'fas fa-spinner fa-spin'
            };
            
            if (statusIcon) {
                statusIcon.className = 'status-icon ' + (icons[type] || icons.ready);
            }

            // Auto-clear success messages
            if (type === 'success') {
                setTimeout(() => {
                    if (statusSection.classList.contains('status-success')) {
                        this.updateStatus('Ready to process more forms', 'ready');
                    }
                }, 5000);
            }
        }
    }

    // Initialize the advanced system
    document.addEventListener('DOMContentLoaded', () => {
        window.advancedAutofillSystem = new AdvancedPatientFormAutofill();
    });

    // Enhanced utility functions
    window.testFunctions = {
        fillPatientData: (data) => {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = data[key];
            });
            window.advancedAutofillSystem.updatePatientData();
        },
        
        getCurrentPatientData: () => {
            return window.advancedAutofillSystem.patientData;
        },
        
        getStats: () => {
            return window.advancedAutofillSystem.stats;
        },
        
        simulateRandomPatients: (count = 5) => {
            console.log(`Generating ${count} random patients for testing...`);
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    window.advancedAutofillSystem.quickFill('random');
                }, i * 1000);
            }
        }
    };

    // Add helpful console messages
    console.log('%c Advanced Patient Form Autofill System Loaded! ', 'color: #27ae60; font-size: 16px; font-weight: bold;');
    console.log('%cKeyboard Shortcuts:', 'color: #3498db; font-weight: bold;');
    console.log(' Ctrl/Cmd + Enter: Process form');
    console.log(' Ctrl/Cmd + 1-4: Quick fill patients (Steve, Joe, Jane, Random)');
    console.log('%cTest Functions:', 'color: #e74c3c; font-weight: bold;');
    console.log(' testFunctions.fillPatientData(data)');
    console.log(' testFunctions.getCurrentPatientData()');
    console.log(' testFunctions.getStats()');
    console.log(' testFunctions.simulateRandomPatients(5)');
</script>
</body>
</html>="health-exam">
                                <i class="fas fa-stethoscope form-card-icon"></i>
                                <div class="form-card-title">Health Exam Form</div>
                                <div class="form-card-description">Comprehensive medical examination form with vital signs and health metrics</div>
                            </div>
                            <div class="sample-form-card" data-form="wic">
                                <i class="fas fa-baby form-card-icon"></i>
                                <div class="form-card-title">WIC Form</div>
                                <div class="form-card-description">Women, Infants, and Children nutritional assistance program form</div>
                            </div>
                            <div class="sample-form-card" data-form