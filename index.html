<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Patient Form Autofill System - Stux Technologies</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: var(--primary-color);
        line-height: 1.6;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header with animations */
    .header {
        background: var(--white);
        padding: 40px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
        animation: slideIn 2s ease-out forwards;
    }

    @keyframes slideIn {
        to { left: 0; }
    }

    .header h1 {
        color: var(--primary-color);
        font-size: 3em;
        margin-bottom: 15px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        color: #7f8c8d;
        font-size: 1.2em;
        font-weight: 300;
    }

    .badge {
        display: inline-block;
        background: var(--success-color);
        color: var(--white);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        margin-top: 10px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Enhanced section styling */
    .section {
        background: var(--white);
        margin-bottom: 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: var(--transition);
    }

    .section:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .section-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: var(--white);
        padding: 20px 30px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .section-header i {
        font-size: 1.5em;
    }

    .section-header h2 {
        font-size: 1.8em;
        font-weight: 600;
    }

    .section-content {
        padding: 30px;
    }

    /* Advanced patient form */
    .patient-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .form-group {
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-color);
        transition: var(--transition);
    }

    .required::after {
        content: ' *';
        color: var(--danger-color);
    }

    .input-container {
        position: relative;
    }

    .form-group input {
        width: 100%;
        padding: 15px 20px;
        padding-right: 45px;
        border: 2px solid #e0e6ed;
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: var(--transition);
        background: var(--white);
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        transform: translateY(-2px);
    }

    .form-group input:valid:not(:placeholder-shown) {
        border-color: var(--success-color);
    }

    .input-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #bdc3c7;
        transition: var(--transition);
    }

    .form-group input:focus + .input-icon,
    .form-group input:valid:not(:placeholder-shown) + .input-icon {
        color: var(--success-color);
    }

    .height-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    /* Enhanced quick fill section */
    .quick-fill {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-top: 25px;
        border: 2px dashed var(--secondary-color);
    }

    .quick-fill h3 {
        margin-bottom: 20px;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .test-patients {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .quick-fill-btn {
        background: linear-gradient(135deg, var(--secondary-color), #2980b9);
        color: var(--white);
        border: none;
        padding: 15px 20px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .quick-fill-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
    }

    .quick-fill-btn:active {
        transform: translateY(-1px);
    }

    /* Advanced form selection */
    .form-options {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 40px;
        align-items: start;
    }

    .sample-forms {
        display: grid;
        gap: 20px;
    }

    .sample-form-card {
        border: 2px solid #e0e6ed;
        border-radius: var(--border-radius);
        padding: 25px;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        position: relative;
        overflow: hidden;
        background: var(--white);
    }

    .sample-form-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: var(--transition);
    }

    .sample-form-card:hover::before {
        left: 100%;
    }

    .sample-form-card:hover {
        border-color: var(--secondary-color);
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    .sample-form-card.selected {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
        transform: scale(1.02);
    }

    .form-card-icon {
        font-size: 3em;
        color: var(--secondary-color);
        margin-bottom: 15px;
        transition: var(--transition);
    }

    .sample-form-card.selected .form-card-icon {
        color: var(--success-color);
        transform: scale(1.1);
    }

    .form-card-title {
        color: var(--primary-color);
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .form-card-description {
        color: #7f8c8d;
        font-size: 14px;
    }

    .option-divider {
        writing-mode: vertical-lr;
        text-orientation: mixed;
        font-size: 1.5em;
        font-weight: bold;
        color: var(--secondary-color);
        text-align: center;
        align-self: center;
        position: relative;
    }

    .option-divider::before,
    .option-divider::after {
        content: '';
        position: absolute;
        left: 50%;
        width: 2px;
        height: 50px;
        background: linear-gradient(var(--secondary-color), transparent);
        transform: translateX(-50%);
    }

    .option-divider::before { top: -60px; }
    .option-divider::after { bottom: -60px; }

    /* Advanced upload area */
    .upload-area {
        border: 3px dashed var(--secondary-color);
        border-radius: var(--border-radius);
        padding: 40px 30px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .upload-area:hover {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        transform: scale(1.02);
    }

    .upload-area.dragover {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
        transform: scale(1.05);
        box-shadow: 0 15px 30px rgba(39, 174, 96, 0.2);
    }

    .upload-area.has-file {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
    }

    .upload-icon {
        font-size: 4em;
        color: var(--secondary-color);
        margin-bottom: 20px;
        transition: var(--transition);
    }

    .upload-area:hover .upload-icon,
    .upload-area.dragover .upload-icon {
        color: var(--success-color);
        transform: scale(1.1);
    }

    .upload-text {
        font-size: 18px;
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 10px;
    }

    .upload-note {
        font-size: 14px;
        color: #7f8c8d;
    }

    .file-info {
        margin-top: 20px;
        padding: 15px;
        background: var(--white);
        border-radius: var(--border-radius);
        border: 2px solid var(--success-color);
        color: var(--success-color);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    /* Enhanced process section */
    .process-section {
        background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
        border-left: 5px solid var(--success-color);
    }

    .process-section.hidden {
        display: none;
    }

    .selected-info {
        background: var(--white);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: var(--transition);
    }

    .info-item:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .info-label {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        color: var(--success-color);
        font-weight: 600;
        font-size: 16px;
    }

    .process-btn {
        background: linear-gradient(135deg, var(--danger-color), #c0392b);
        color: var(--white);
        border: none;
        padding: 20px 40px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: var(--transition);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        position: relative;
        overflow: hidden;
    }

    .process-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: var(--transition);
    }

    .process-btn:hover:not(:disabled)::before {
        left: 100%;
    }

    .process-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(231, 76, 60, 0.3);
    }

    .process-btn:disabled {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        cursor: not-allowed;
        transform: none;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid transparent;
        border-top: 3px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced status section */
    .status-section {
        padding: 20px 30px;
        border-radius: var(--border-radius);
        text-align: center;
        font-weight: 500;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: var(--transition);
    }

    .status-ready { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1976d2; }
    .status-success { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); color: var(--success-color); }
    .status-error { background: linear-gradient(135deg, #ffebee, #ffcdd2); color: var(--danger-color); }
    .status-processing { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: var(--warning-color); }

    .status-icon {
        font-size: 1.2em;
    }

    /* Enhanced debug section */
    .debug-section {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-left: 4px solid #17a2b8;
        margin-top: 20px;
    }

    .debug-section.hidden {
        display: none;
    }

    .field-list {
        background: var(--primary-color);
        color: #00ff00;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    /* Progress indicator */
    .progress-container {
        width: 100%;
        height: 6px;
        background: #e0e6ed;
        border-radius: 3px;
        margin: 20px 0;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
        width: 0%;
        transition: width 0.5s ease;
        position: relative;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Validation indicators */
    .validation-indicator {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: var(--transition);
    }

    .validation-indicator.valid {
        background: var(--success-color);
        color: var(--white);
    }

    .validation-indicator.invalid {
        background: var(--danger-color);
        color: var(--white);
    }

    /* Success animations */
    .success-animation {
        animation: successPulse 0.8s ease-in-out;
    }

    @keyframes successPulse {
        0%, 100% { transform: scale(1); }
        25% { transform: scale(1.05); }
        50% { transform: scale(1.1); }
        75% { transform: scale(1.05); }
    }

    .download-animation {
        animation: downloadBounce 0.6s ease-in-out;
    }

    @keyframes downloadBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .container { padding: 15px; }
        .header { padding: 30px 20px; }
        .header h1 { font-size: 2.2em; }
        .patient-grid { grid-template-columns: 1fr; }
        .form-options { 
            grid-template-columns: 1fr; 
            gap: 20px; 
        }
        .option-divider { 
            display: none; 
        }
        .test-patients { grid-template-columns: 1fr; }
        .info-grid { grid-template-columns: 1fr; }
        .height-container { grid-template-columns: 1fr; }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --primary-color: #ecf0f1;
            --white: #2c3e50;
            --light-bg: #34495e;
        }
    }

    /* Print styles */
    @media print {
        body { background: white; }
        .section { box-shadow: none; }
        .debug-section { display: none !important; }
    }

    /* Accessibility improvements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Focus indicators for keyboard navigation */
    *:focus {
        outline: 2px solid var(--secondary-color);
        outline-offset: 2px;
    }

    /* Tooltip styles */
    .tooltip {
        position: relative;
        cursor: help;
    }

    .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: var(--white);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: var(--transition);
    }

    .tooltip:hover::after {
        opacity: 1;
    }
</style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Header -->
        <div class="header">
            <h1><i class="fas fa-heartbeat"></i> Advanced Patient Form Autofill</h1>
            <p class="subtitle">Stux Technologies - Next-Generation Medical Form Automation</p>
            <div class="badge"><i class="fas fa-shield-alt"></i> 100% Secure & Offline</div>
        </div>
    <!-- Enhanced Patient Information Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-user-md"></i>
            <h2>Patient Information</h2>
        </div>
        <div class="section-content">
            <div class="patient-grid">
                <div class="form-group">
                    <label for="firstName" class="required">First Name</label>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="firstName" 
                            placeholder="Enter first name" 
                            required
                            autocomplete="given-name"
                        >
                        <i class="fas fa-user input-icon"></i>
                        <div class="validation-indicator" id="firstNameValidation"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="lastName" class="required">Last Name</label>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="lastName" 
                            placeholder="Enter last name" 
                            required
                            autocomplete="family-name"
                        >
                        <i class="fas fa-user input-icon"></i>
                        <div class="validation-indicator" id="lastNameValidation"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="required">Height</label>
                    <div class="height-container">
                        <div class="input-container">
                            <input 
                                type="number" 
                                id="heightFeet" 
                                placeholder="Feet" 
                                min="0" 
                                max="8" 
                                required
                                class="tooltip"
                                data-tooltip="Enter height in feet (0-8)"
                            >
                            <i class="fas fa-ruler-vertical input-icon"></i>
                            <div class="validation-indicator" id="heightFeetValidation"></div>
                        </div>
                        <div class="input-container">
                            <input 
                                type="number" 
                                id="heightInches" 
                                placeholder="Inches" 
                                min="0" 
                                max="11" 
                                required
                                class="tooltip"
                                data-tooltip="Enter additional inches (0-11)"
                            >
                            <i class="fas fa-ruler input-icon"></i>
                            <div class="validation-indicator" id="heightInchesValidation"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="weight" class="required">Weight (pounds)</label>
                    <div class="input-container">
                        <input 
                            type="number" 
                            id="weight" 
                            placeholder="Enter weight in pounds" 
                            min="0" 
                            required
                            class="tooltip"
                            data-tooltip="Enter weight in pounds"
                        >
                        <i class="fas fa-weight input-icon"></i>
                        <div class="validation-indicator" id="weightValidation"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="birthday">Birthday (Optional)</label>
                    <div class="input-container">
                        <input 
                            type="date" 
                            id="birthday"
                            autocomplete="bday"
                        >
                        <i class="fas fa-calendar-alt input-icon"></i>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="completionProgress"></div>
            </div>

            <div class="quick-fill">
                <h3><i class="fas fa-rocket"></i> Quick Fill Test Data</h3>
                <div class="test-patients">
                    <button class="quick-fill-btn" data-patient="steve">
                        <i class="fas fa-male"></i>
                        Steve Testing<br>
                        <small>5'10", 180 lb, DOB: 8/9/2000</small>
                    </button>
                    <button class="quick-fill-btn" data-patient="joe">
                        <i class="fas fa-male"></i>
                        Joe Doe<br>
                        <small>6'0", 210 lb, DOB: 8/9/1990</small>
                    </button>
                    <button class="quick-fill-btn" data-patient="jane">
                        <i class="fas fa-female"></i>
                        Jane Smith<br>
                        <small>5'6", 140 lb, DOB: 3/15/1985</small>
                    </button>
                    <button class="quick-fill-btn" data-patient="random">
                        <i class="fas fa-random"></i>
                        Random Patient<br>
                        <small>Generate random data</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Form Selection Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-file-pdf"></i>
            <h2>Form Selection</h2>
        </div>
        <div class="section-content">
            <div class="form-options">
                <!-- Sample Forms -->
                <div>
                    <h3><i class="fas fa-clipboard-list"></i> Sample Forms</h3>
                    <div class="sample-forms">
                        <div class="sample-form-card" data-form="health-exam">
                            <i class="fas fa-stethoscope form-card-icon"></i>
                            <div class="form-card-title">Health Exam Form</div>
                            <div class="form-card-description">Comprehensive medical examination form with vital signs and health metrics</div>
                        </div>
                        <div class="sample-form-card" data-form="wic">
                            <i class="fas fa-baby form-card-icon"></i>
                            <div class="form-card-title">WIC Form</div>
                            <div class="form-card-description">Women, Infants, and Children nutritional assistance program form</div>
                        </div>
                    </div>
                </div>

                <div class="option-divider">OR</div>

                <!-- Upload Custom Form -->
                <div>
                    <h3><i class="fas fa-cloud-upload-alt"></i> Upload Custom PDF</h3>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="pdfUpload" accept=".pdf" hidden>
                        <i class="fas fa-file-pdf upload-icon"></i>
                        <div class="upload-text">Click to upload PDF or drag and drop</div>
                        <div class="upload-note">Supports fillable PDF forms up to 10MB</div>
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span id="fileName"></span>
                            <span id="fileSize"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Process Section -->
    <div class="section process-section hidden" id="processSection">
        <div class="section-header">
            <i class="fas fa-cogs"></i>
            <h2>Ready to Process</h2>
        </div>
        <div class="section-content">
            <div class="selected-info">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-user"></i> Patient Name</span>
                        <span class="info-value" id="patientNameDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-ruler-vertical"></i> Height</span>
                        <span class="info-value" id="heightDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-weight"></i> Weight</span>
                        <span class="info-value" id="weightDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-birthday-cake"></i> Birthday</span>
                        <span class="info-value" id="birthdayDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-file-pdf"></i> Selected Form</span>
                        <span class="info-value" id="formDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-chart-line"></i> Mapping Confidence</span>
                        <span class="info-value" id="confidenceDisplay">-</span>
                    </div>
                </div>
                <button class="process-btn" id="processBtn" disabled>
                    <i class="fas fa-magic" id="btnIcon"></i>
                    <span id="btnText">Fill Form & Download PDF</span>
                    <span class="loading" id="btnLoading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Status Section -->
    <div class="status-section status-ready" id="statusSection">
        <i class="fas fa-info-circle status-icon"></i>
        <div id="statusText">Ready to process forms - Enter patient data and select a form</div>
    </div>

    <!-- Enhanced Debug Section -->
    <div class="section debug-section hidden" id="debugSection">
        <div class="section-header">
            <i class="fas fa-bug"></i>
            <h2>PDF Analysis & Field Mapping</h2>
        </div>
        <div class="section-content">
            <div class="field-list" id="fieldList"></div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="quick-fill-btn" onclick="app.showAllFieldNames()" style="margin-right: 10px;">
                    <i class="fas fa-list"></i> Show All Field Names
                </button>
                <button class="quick-fill-btn" onclick="app.createCustomMappings()" style="margin-right: 10px;">
                    <i class="fas fa-cog"></i> Create Custom Mappings
                </button>
                <button class="quick-fill-btn" onclick="app.debugFieldMapping()" style="margin-right: 10px;">
                    <i class="fas fa-bug"></i> Debug Field Mapping
                </button>
                <button class="quick-fill-btn" onclick="app.testFieldFilling()" style="margin-right: 10px;">
                    <i class="fas fa-vial"></i> Test Field Filling
                </button>
                <button class="quick-fill-btn" onclick="document.getElementById('debugSection').classList.add('hidden')">
                    <i class="fas fa-times"></i> Close Debug View
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="section" id="statsSection" style="display: none;">
        <div class="section-header">
            <i class="fas fa-chart-bar"></i>
            <h2>Processing Statistics</h2>
        </div>
        <div class="section-content">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Forms Processed</span>
                    <span class="info-value" id="formsProcessed">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Fields Mapped</span>
                    <span class="info-value" id="fieldsMapped">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Success Rate</span>
                    <span class="info-value" id="successRate">0%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Avg. Processing Time</span>
                    <span class="info-value" id="avgTime">0s</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    class AdvancedPatientFormAutofill {
        constructor() {
            this.patientData = {};
            this.selectedForm = null;
            this.uploadedFile = null;
            this.pdfDoc = null;
            this.stats = {
                formsProcessed: 0,
                fieldsMapped: 0,
                totalProcessingTime: 0,
                successCount: 0
            };
            
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.setupValidation();
            this.updateStatus('System ready - Enter patient data and select a form', 'ready');
            this.loadStats();
        }

        setupEventListeners() {
            // Enhanced patient form inputs with real-time validation
            const inputs = ['firstName', 'lastName', 'heightFeet', 'heightInches', 'weight', 'birthday'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                input.addEventListener('input', () => {
                    this.updatePatientData();
                    this.validateField(inputId);
                    this.updateCompletionProgress();
                });
                input.addEventListener('blur', () => this.validateField(inputId));
            });

            // Enhanced quick fill buttons
            document.querySelectorAll('.quick-fill-btn')
                .forEach(btn => btn.addEventListener('click', (e) => this.quickFill(e.target.dataset.patient)));

            // Enhanced sample form selection
            document.querySelectorAll('.sample-form-card')
                .forEach(card => card.addEventListener('click', (e) => this.selectSampleForm(e.currentTarget.dataset.form)));

            // Enhanced file upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('pdfUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
            uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
            uploadArea.addEventListener('drop', this.handleDrop.bind(this));
            fileInput.addEventListener('change', this.handleFileSelect.bind(this));

            // Enhanced process button
            document.getElementById('processBtn').addEventListener('click', () => this.processForm());

            // Keyboard shortcuts
            document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
        }

        setupValidation() {
            this.validationRules = {
                firstName: {
                    required: true,
                    minLength: 1,
                    pattern: /^[a-zA-Z\s'-]+$/,
                    message: 'First name should contain only letters, spaces, hyphens, and apostrophes'
                },
                lastName: {
                    required: true,
                    minLength: 1,
                    pattern: /^[a-zA-Z\s'-]+$/,
                    message: 'Last name should contain only letters, spaces, hyphens, and apostrophes'
                },
                heightFeet: {
                    required: true,
                    min: 0,
                    max: 8,
                    message: 'Height in feet should be between 0-8'
                },
                heightInches: {
                    required: true,
                    min: 0,
                    max: 11,
                    message: 'Height in inches should be between 0-11'
                },
                weight: {
                    required: true,
                    min: 1,
                    max: 1000,
                    message: 'Weight should be between 1-1000 pounds'
                }
            };
        }

        validateField(fieldId) {
            const input = document.getElementById(fieldId);
            const indicator = document.getElementById(fieldId + 'Validation');
            const rules = this.validationRules[fieldId];
            
            if (!rules || !indicator) return true;

            let isValid = true;
            let message = '';

            // Required validation
            if (rules.required && (!input.value || input.value.trim() === '')) {
                isValid = false;
                message = 'This field is required';
            }
            // Pattern validation
            else if (rules.pattern && !rules.pattern.test(input.value)) {
                isValid = false;
                message = rules.message;
            }
            // Min/Max validation for numbers
            else if (rules.min !== undefined || rules.max !== undefined) {
                const value = parseFloat(input.value);
                if (rules.min !== undefined && value < rules.min) {
                    isValid = false;
                    message = rules.message;
                } else if (rules.max !== undefined && value > rules.max) {
                    isValid = false;
                    message = rules.message;
                }
            }

            // Update indicator
            indicator.className = 'validation-indicator ' + (isValid ? 'valid' : 'invalid');
            indicator.innerHTML = isValid ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
            indicator.title = isValid ? 'Valid' : message;

            return isValid;
        }

        updateCompletionProgress() {
            const requiredFields = ['firstName', 'lastName', 'heightFeet', 'heightInches', 'weight'];
            const completedFields = requiredFields.filter(fieldId => {
                const input = document.getElementById(fieldId);
                return input.value && input.value.trim() !== '' && this.validateField(fieldId);
            }).length;

            const progress = (completedFields / requiredFields.length) * 100;
            document.getElementById('completionProgress').style.width = progress + '%';
        }

        updatePatientData() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const heightFeet = document.getElementById('heightFeet').value;
            const heightInches = document.getElementById('heightInches').value;
            const weight = document.getElementById('weight').value;
            const birthday = document.getElementById('birthday').value;

            this.patientData = {
                firstName,
                lastName,
                heightFeet,
                heightInches,
                weight,
                birthday,
                fullName: `${firstName} ${lastName}`.trim(),
                heightString: heightFeet && heightInches ? `${heightFeet}'${heightInches}"` : '',
                heightInCm: heightFeet && heightInches ? Math.round((parseInt(heightFeet) * 12 + parseInt(heightInches)) * 2.54) : '',
                weightInKg: weight ? Math.round(weight * 0.453592) : '',
                age: birthday ? this.calculateAge(birthday) : '',
                bmi: this.calculateBMI(heightFeet, heightInches, weight),
                // Multiple date formats for different PDF forms
                birthdayFormatted: birthday ? this.formatDateForPDF(birthday) : '',
                birthdayMMDDYYYY: birthday ? this.formatDateMMDDYYYY(birthday) : '',
                birthdayDDMMYYYY: birthday ? this.formatDateDDMMYYYY(birthday) : ''
            };

            this.updateProcessSection();
            this.checkReadyToProcess();
        }

        calculateAge(birthday) {
            const today = new Date();
            const birthDate = new Date(birthday);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        calculateBMI(feet, inches, weightLbs) {
            if (!feet || !inches || !weightLbs) return '';
            
            const heightInches = parseInt(feet) * 12 + parseInt(inches);
            const heightM = heightInches * 0.0254;
            const weightKg = weightLbs * 0.453592;
            const bmi = weightKg / (heightM * heightM);
            
            return Math.round(bmi * 10) / 10;
        }

        formatDateForPDF(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
        }

        formatDateMMDDYYYY(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        formatDateDDMMYYYY(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        quickFill(patientType) {
            const testData = {
                steve: {
                    firstName: 'Steve',
                    lastName: 'Testing',
                    heightFeet: '5',
                    heightInches: '10',
                    weight: '180',
                    birthday: '2000-08-09'
                },
                joe: {
                    firstName: 'Joe',
                    lastName: 'Doe',
                    heightFeet: '6',
                    heightInches: '0',
                    weight: '210',
                    birthday: '1990-08-09'
                },
                jane: {
                    firstName: 'Jane',
                    lastName: 'Smith',
                    heightFeet: '5',
                    heightInches: '6',
                    weight: '140',
                    birthday: '1985-03-15'
                },
                random: this.generateRandomPatient()
            };

            const data = testData[patientType];
            if (data) {
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = data[key];
                        // Add typing animation
                        this.animateTyping(input, data[key]);
                    }
                });
                
                setTimeout(() => {
                    this.updatePatientData();
                    this.updateStatus(`Loaded patient: ${data.firstName} ${data.lastName}`, 'success');
                }, 500);
            }
        }

        generateRandomPatient() {
            const firstNames = ['Alex', 'Taylor', 'Jordan', 'Casey', 'Morgan', 'Riley', 'Avery', 'Quinn'];
            const lastNames = ['Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Wilson'];
            
            return {
                firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                heightFeet: String(Math.floor(Math.random() * 3) + 5), // 5-7 feet
                heightInches: String(Math.floor(Math.random() * 12)), // 0-11 inches
                weight: String(Math.floor(Math.random() * 100) + 120), // 120-220 lbs
                birthday: this.generateRandomBirthday()
            };
        }

        generateRandomBirthday() {
            const start = new Date(1950, 0, 1);
            const end = new Date(2005, 11, 31);
            const date = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
            return date.toISOString().split('T')[0];
        }

        animateTyping(input, text) {
            input.value = '';
            let i = 0;
            const typeInterval = setInterval(() => {
                if (i < text.length) {
                    input.value += text[i];
                    i++;
                } else {
                    clearInterval(typeInterval);
                    input.dispatchEvent(new Event('input'));
                }
            }, 50);
        }

        async selectSampleForm(formType) {
            // Clear previous selections with animation
            document.querySelectorAll('.sample-form-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[data-form="${formType}"]`);
            selectedCard.classList.add('selected');
            
            // Clear uploaded file
            this.uploadedFile = null;
            this.pdfDoc = null;
            document.getElementById('uploadArea').classList.remove('has-file');
            document.getElementById('fileInfo').style.display = 'none';

            this.selectedForm = formType;
            
            try {
                // Load the actual PDF file
                this.updateStatus('Loading sample form...', 'processing');
                const pdfPath = `sample-forms/${formType === 'health-exam' ? 'health-exam-form.pdf' : 'wicform.pdf'}`;
                
                const response = await fetch(pdfPath);
                if (!response.ok) {
                    throw new Error(`Failed to load PDF: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                this.pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Analyze the PDF fields
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                const analysis = this.performFieldAnalysis(fields);
                
                // Check if WIC Form has no fields and create a fillable one
                if (formType === 'wic' && fields.length === 0) {
                    this.updateStatus('WIC Form has no fillable fields. Creating a fillable version...', 'processing');
                    await this.createFillableWICForm();
                    
                    // After creating the fillable form, analyze it again
                    const newForm = this.pdfDoc.getForm();
                    const newFields = newForm.getFields();
                    const newAnalysis = this.performFieldAnalysis(newFields);
                    
                    // Show debug info for the new fillable form
                    this.showAdvancedDebugInfo(newFields, newAnalysis);
                    
                    // Update confidence score
                    document.getElementById('confidenceDisplay').textContent = newAnalysis.confidence + '%';
                    
                    this.updateStatus('✅ Fillable WIC Form created and loaded! The form is now ready for auto-filling.', 'success');
                    this.updateProcessSection();
                    this.checkReadyToProcess();
                    return;
                }
                
                // Show debug info for sample forms
                this.showAdvancedDebugInfo(fields, analysis);
                
                // Update confidence score
                document.getElementById('confidenceDisplay').textContent = analysis.confidence + '%';
                
                this.updateStatus(`Loaded: ${formType === 'health-exam' ? 'Health Exam Form' : 'WIC Form'}`, 'success');
                
            } catch (error) {
                console.error('Error loading sample form:', error);
                this.updateStatus(`Error loading ${formType} form: ${error.message}`, 'error');
                // Fallback to generated form
                this.pdfDoc = null;
            }
            
            this.updateProcessSection();
            this.checkReadyToProcess();
        }

        handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        }

        handleFileSelect(e) {
            if (e.target.files.length > 0) {
                this.handleFile(e.target.files[0]);
            }
        }

        async handleFile(file) {
            if (file.type !== 'application/pdf') {
                this.updateStatus('Please select a PDF file', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                this.updateStatus('File size too large. Please select a file under 10MB', 'error');
                return;
            }

            try {
                this.updateStatus('Analyzing PDF...', 'processing');
                
                // Clear sample form selection
                document.querySelectorAll('.sample-form-card').forEach(card => card.classList.remove('selected'));
                this.selectedForm = null;

                // Set uploaded file
                this.uploadedFile = file;
                
                // Update UI with enhanced file info
                const uploadArea = document.getElementById('uploadArea');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const fileSize = document.getElementById('fileSize');
                
                uploadArea.classList.add('has-file');
                fileInfo.style.display = 'flex';
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;

                // Analyze PDF with progress
                await this.analyzePDFAdvanced(file);
                
                this.updateProcessSection();
                this.checkReadyToProcess();
                this.updateStatus(`PDF analyzed: ${file.name}`, 'success');

            } catch (error) {
                console.error('Error handling file:', error);
                this.updateStatus('Error analyzing PDF file', 'error');
            }
        }

        async analyzePDFAdvanced(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                this.pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                
                // Advanced field analysis
                const analysis = this.performFieldAnalysis(fields);
                
                // Show enhanced debug info
                this.showAdvancedDebugInfo(fields, analysis);
                
                // Update confidence score
                document.getElementById('confidenceDisplay').textContent = analysis.confidence + '%';

            } catch (error) {
                console.error('Error analyzing PDF:', error);
                this.updateStatus('Could not analyze PDF form fields', 'error');
                throw error;
            }
        }

        performFieldAnalysis(fields) {
            let mappedFields = 0;
            const totalFields = fields.length;
            const fieldTypes = {};
            const mappings = {};

            // Enhanced field mapping patterns
            const enhancedPatterns = {
                firstName: ['first_name', 'firstname', 'fname', 'first-name', 'givenname', 'patient_first', 'name_first', 'given_name', 'forename'],
                lastName: ['last_name', 'lastname', 'lname', 'last-name', 'surname', 'familyname', 'patient_last', 'name_last', 'family_name'],
                fullName: ['full_name', 'fullname', 'name', 'patient_name', 'client_name', 'person_name', 'complete_name'],
                height: ['height', 'ht', 'stature', 'patient_height', 'height_ft_in', 'height_feet_inches', 'tall', 'tallness'],
                heightFeet: ['height_ft', 'height_feet', 'feet', 'ft', 'height_f', 'ht_ft'],
                heightInches: ['height_in', 'height_inches', 'inches', 'in', 'height_i', 'ht_in'],
                weight: ['weight', 'wt', 'mass', 'patient_weight', 'weight_lbs', 'weight_pounds', 'body_weight', 'wgt'],
                birthday: ['birthday', 'birth_date', 'birthdate', 'dob', 'date_of_birth', 'patient_dob', 'birth_day', 'bday'],
                age: ['age', 'patient_age', 'years_old', 'yrs', 'years'],
                bmi: ['bmi', 'body_mass_index', 'mass_index', 'bm_index']
            };

            fields.forEach(field => {
                const fieldName = field.getName().toLowerCase();
                const fieldType = field.constructor.name;
                
                // Count field types
                fieldTypes[fieldType] = (fieldTypes[fieldType] || 0) + 1;
                
                // Check for mappings
                Object.keys(enhancedPatterns).forEach(dataKey => {
                    if (enhancedPatterns[dataKey].some(pattern => fieldName.includes(pattern))) {
                        mappings[field.getName()] = dataKey;
                        mappedFields++;
                    }
                });
            });

            const confidence = Math.round((mappedFields / Math.max(totalFields, 1)) * 100);

            return {
                totalFields,
                mappedFields,
                fieldTypes,
                mappings,
                confidence: Math.min(confidence, 95) // Cap at 95% for uploaded forms
            };
        }

        showAdvancedDebugInfo(fields, analysis) {
            const debugSection = document.getElementById('debugSection');
            const fieldList = document.getElementById('fieldList');
            
            let debugText = `PDF FORM ANALYSIS COMPLETE\n`;
            debugText += `==========================\n\n`;
            debugText += `📊 STATISTICS:\n`;
            debugText += `Total Fields: ${analysis.totalFields}\n`;
            debugText += `Mappable Fields: ${analysis.mappedFields}\n`;
            debugText += `Confidence Score: ${analysis.confidence}%\n\n`;
            
            debugText += `🏷️  FIELD TYPES:\n`;
            Object.entries(analysis.fieldTypes).forEach(([type, count]) => {
                debugText += `${type}: ${count}\n`;
            });
            
            debugText += `\n🔗 FIELD MAPPINGS:\n`;
            fields.forEach((field, index) => {
                const mapping = analysis.mappings[field.getName()] || 'unmapped';
                const indicator = mapping !== 'unmapped' ? '✅' : '❌';
                const fieldType = field.constructor.name;
                debugText += `${indicator} ${index + 1}. ${field.getName()} (${fieldType}) → ${mapping}\n`;
            });
            
            debugText += `\n💡 MAPPING STRATEGY:\n`;
            debugText += `System uses exact field name matching first, then case-insensitive,\n`;
            debugText += `then partial matching as fallback.\n`;
            debugText += `Supports text fields, dropdowns, checkboxes, and radio buttons.\n`;
            debugText += `Additional calculated fields: BMI, Age, Height in CM, Weight in KG\n`;
            
            // Add form-specific information
            if (this.selectedForm) {
                debugText += `\n📋 FORM TYPE: ${this.selectedForm === 'health-exam' ? 'Health Examination Form' : 'WIC Nutritional Form'}\n`;
                debugText += `Using form-specific field mappings for better accuracy.\n`;
            }
            
            fieldList.textContent = debugText;
            debugSection.classList.remove('hidden');
        }

        updateProcessSection() {
            const section = document.getElementById('processSection');
            const displays = {
                patientNameDisplay: this.patientData.fullName || '-',
                heightDisplay: this.patientData.heightString || '-',
                weightDisplay: this.patientData.weight ? `${this.patientData.weight} lbs` : '-',
                birthdayDisplay: this.patientData.birthday ? new Date(this.patientData.birthday).toLocaleDateString() : '-',
                formDisplay: this.getFormDisplayName()
            };

            Object.entries(displays).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            const hasData = this.patientData.fullName || this.selectedForm || this.uploadedFile;
            section.classList.toggle('hidden', !hasData);
        }

        getFormDisplayName() {
            if (this.selectedForm) {
                const formNames = {
                    'health-exam': 'Health Examination Form',
                    'wic': 'WIC Nutritional Form'
                };
                return formNames[this.selectedForm] || this.selectedForm;
            } else if (this.uploadedFile) {
                return this.uploadedFile.name;
            }
            return '-';
        }

        checkReadyToProcess() {
            const processBtn = document.getElementById('processBtn');
            const requiredFields = ['firstName', 'lastName', 'heightFeet', 'heightInches', 'weight'];
            const hasRequiredData = requiredFields.every(fieldId => {
                const input = document.getElementById(fieldId);
                return input.value && input.value.trim() !== '' && this.validateField(fieldId);
            });
            const hasForm = this.selectedForm || this.uploadedFile;

            processBtn.disabled = !(hasRequiredData && hasForm);
            
            // Update button appearance based on readiness
            if (!processBtn.disabled) {
                processBtn.style.background = 'linear-gradient(135deg, var(--success-color), #229954)';
                document.getElementById('btnIcon').className = 'fas fa-rocket';
            } else {
                processBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
                document.getElementById('btnIcon').className = 'fas fa-magic';
            }
        }

        async processForm() {
            const startTime = Date.now();
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            const btnIcon = document.getElementById('btnIcon');
            
            try {
                // Show enhanced loading state
                btnIcon.style.display = 'none';
                btnText.textContent = 'Processing...';
                btnLoading.style.display = 'inline-block';
                this.updateStatus('🔄 Processing form with advanced field mapping...', 'processing');

                if (this.uploadedFile) {
                    await this.processUploadedFormAdvanced();
                } else {
                    await this.processSampleFormAdvanced();
                }

                // Update statistics
                const processingTime = Date.now() - startTime;
                this.updateStats(true, processingTime);

            } catch (error) {
                console.error('Processing error:', error);
                this.updateStatus(`❌ Error: ${error.message}`, 'error');
                this.updateStats(false, Date.now() - startTime);
            } finally {
                // Reset button state
                btnIcon.style.display = 'inline';
                btnText.textContent = 'Fill Form & Download PDF';
                btnLoading.style.display = 'none';
            }
        }

        async processUploadedFormAdvanced() {
            if (!this.pdfDoc) {
                await this.analyzePDFAdvanced(this.uploadedFile);
            }

            const form = this.pdfDoc.getForm();
            const fields = form.getFields();
            
            // Create enhanced field mappings
            const mappings = this.createAdvancedFieldMappings(fields);
            
            // Fill PDF fields with enhanced data
                            const filledFields = await this.fillPDFFieldsAdvanced(form, mappings);

            // Generate filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `${this.patientData.firstName}_${this.patientData.lastName}_${this.uploadedFile.name.replace('.pdf', '')}_${timestamp}.pdf`;

            // Save and download
            const pdfBytes = await this.pdfDoc.save();
            this.downloadPDF(pdfBytes, filename);
            
            this.updateStatus(`✅ Success! Filled ${filledFields} fields in ${filename}`, 'success');
            this.addSuccessAnimation();
            
            // Update statistics display
            this.stats.fieldsMapped += filledFields;
            this.updateStatsDisplay();
        }

        async processSampleFormAdvanced() {
            if (!this.pdfDoc) {
                this.updateStatus('Error: No PDF loaded for sample form', 'error');
                return;
            }

            try {
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                
                // Create enhanced field mappings for specific forms
                const mappings = this.createSampleFormFieldMappings(fields);
                
                // Fill PDF fields with enhanced data
                const filledFields = await this.fillPDFFieldsAdvanced(form, mappings);

                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const formFileName = this.selectedForm === 'health-exam' ? 'health-exam-form' : 'wicform';
                const filename = `${this.patientData.firstName}_${this.patientData.lastName}_${formFileName}_filled_${timestamp}.pdf`;

                // Save and download
                const pdfBytes = await this.pdfDoc.save();
                this.downloadPDF(pdfBytes, filename);
                
                this.updateStatus(`✅ Success! Filled ${filledFields} fields in ${filename}`, 'success');
                this.addSuccessAnimation();
                
                // Update statistics
                this.stats.fieldsMapped += filledFields;
                this.updateStatsDisplay();
                
            } catch (error) {
                console.error('Error processing sample form:', error);
                this.updateStatus(`Error processing form: ${error.message}`, 'error');
            }
        }

        createAdvancedFieldMappings(fields) {
            const mappings = {};
            const fieldNames = fields.map(f => f.getName().toLowerCase());

            // Enhanced mapping patterns with scoring
            const patterns = {
                firstName: {
                    patterns: ['first_name', 'firstname', 'fname', 'first-name', 'givenname', 'patient_first', 'name_first', 'given_name', 'forename'],
                    value: () => this.patientData.firstName
                },
                lastName: {
                    patterns: ['last_name', 'lastname', 'lname', 'last-name', 'surname', 'familyname', 'patient_last', 'name_last', 'family_name'],
                    value: () => this.patientData.lastName
                },
                fullName: {
                    patterns: ['full_name', 'fullname', 'name', 'patient_name', 'client_name', 'person_name', 'complete_name'],
                    value: () => this.patientData.fullName
                },
                height: {
                    patterns: ['height', 'ht', 'stature', 'patient_height', 'height_ft_in', 'height_feet_inches', 'tall'],
                    value: () => this.patientData.heightString
                },
                heightFeet: {
                    patterns: ['height_ft', 'height_feet', 'feet', 'ft', 'height_f', 'ht_ft'],
                    value: () => this.patientData.heightFeet
                },
                heightInches: {
                    patterns: ['height_in', 'height_inches', 'inches', 'in', 'height_i', 'ht_in'],
                    value: () => this.patientData.heightInches
                },
                heightCm: {
                    patterns: ['height_cm', 'height_centimeters', 'cm', 'centimeters', 'height_metric'],
                    value: () => this.patientData.heightInCm
                },
                weight: {
                    patterns: ['weight', 'wt', 'mass', 'patient_weight', 'weight_lbs', 'weight_pounds', 'body_weight'],
                    value: () => this.patientData.weight
                },
                weightKg: {
                    patterns: ['weight_kg', 'weight_kilograms', 'kg', 'kilograms', 'weight_metric'],
                    value: () => this.patientData.weightInKg
                },
                birthday: {
                    patterns: ['birthday', 'birth_date', 'birthdate', 'dob', 'date_of_birth', 'patient_dob', 'birth_day'],
                    value: () => this.patientData.birthday
                },
                age: {
                    patterns: ['age', 'patient_age', 'years_old', 'yrs', 'years'],
                    value: () => this.patientData.age
                },
                bmi: {
                    patterns: ['bmi', 'body_mass_index', 'mass_index', 'bm_index'],
                    value: () => this.patientData.bmi
                }
            };

            // Match patterns to actual form fields
            Object.entries(patterns).forEach(([dataKey, config]) => {
                const matchingFields = fieldNames.filter(fieldName => 
                    config.patterns.some(pattern => fieldName.includes(pattern.toLowerCase()))
                );

                matchingFields.forEach(fieldName => {
                    const originalFieldName = fields.find(f => f.getName().toLowerCase() === fieldName)?.getName();
                    if (originalFieldName && config.value()) {
                        mappings[originalFieldName] = config.value();
                    }
                });
            });

            console.log('Advanced Field Mappings:', mappings);
            return mappings;
        }

        createSampleFormFieldMappings(fields) {
            const mappings = {};
            
            // Get all field names for debugging
            const allFieldNames = fields.map(f => f.getName());
            console.log(`All field names in ${this.selectedForm} form:`, allFieldNames);
            
            // Enhanced field mapping approach for both forms
            const fieldMappings = {
                'health-exam': {
                    // Actual field names from Health Exam Form
                    'Name': this.patientData.fullName,
                    'DOB': this.patientData.birthdayFormatted,
                    'Height': this.patientData.heightString,
                    'Weight': this.patientData.weight,
                    'BMI': this.patientData.bmi,
                    // Additional variations
                    'name': this.patientData.fullName,
                    'dob': this.patientData.birthdayFormatted,
                    'height': this.patientData.heightString,
                    'weight': this.patientData.weight,
                    'bmi': this.patientData.bmi,
                    // Common patterns as fallback
                    'first_name': this.patientData.firstName,
                    'last_name': this.patientData.lastName,
                    'full_name': this.patientData.fullName,
                    'patient_name': this.patientData.fullName,
                    'birth_date': this.patientData.birthdayFormatted,
                    'date_of_birth': this.patientData.birthdayFormatted,
                    'age': this.patientData.age,
                    'fname': this.patientData.firstName,
                    'lname': this.patientData.lastName,
                    'given_name': this.patientData.firstName,
                    'family_name': this.patientData.lastName,
                    'surname': this.patientData.lastName,
                    'forename': this.patientData.firstName,
                    'ht': this.patientData.heightString,
                    'wt': this.patientData.weight,
                    'stature': this.patientData.heightString,
                    'mass': this.patientData.weight,
                    'body_weight': this.patientData.weight,
                    'patient_weight': this.patientData.weight,
                    'patient_height': this.patientData.heightString,
                    'birthday': this.patientData.birthdayFormatted,
                    'birth_day': this.patientData.birthdayFormatted,
                    'years_old': this.patientData.age,
                    'yrs': this.patientData.age,
                    'years': this.patientData.age,
                    'body_mass_index': this.patientData.bmi,
                    'mass_index': this.patientData.bmi,
                    'bm_index': this.patientData.bmi
                },
                'wic': {
                    // Fillable WIC Form field names (created by our tool)
                    'participant_name': this.patientData.fullName,
                    'date_of_birth': this.patientData.birthdayFormatted,
                    'age': this.patientData.age,
                    'height': this.patientData.heightString,
                    'weight': this.patientData.weight,
                    'bmi': this.patientData.bmi,
                    'contact_info': `${this.patientData.fullName} - Contact Info`,
                    'emergency_contact': `Emergency Contact for ${this.patientData.fullName}`,
                    'assessment_date': new Date().toLocaleDateString(),
                    'provider_signature': 'Healthcare Provider',
                    'signature_date': new Date().toLocaleDateString(),
                    // Additional common patterns for any WIC form
                    'first_name': this.patientData.firstName,
                    'last_name': this.patientData.lastName,
                    'name': this.patientData.fullName,
                    'full_name': this.patientData.fullName,
                    'client_name': this.patientData.fullName,
                    'participant': this.patientData.fullName,
                    'client': this.patientData.fullName,
                    'wic_participant': this.patientData.fullName,
                    'wic_client': this.patientData.fullName,
                    'birth_date': this.patientData.birthdayFormatted,
                    'dob': this.patientData.birthdayFormatted,
                    'date_of_birth': this.patientData.birthdayFormatted,
                    'fname': this.patientData.firstName,
                    'lname': this.patientData.lastName,
                    'given_name': this.patientData.firstName,
                    'family_name': this.patientData.lastName,
                    'surname': this.patientData.lastName,
                    'forename': this.patientData.firstName,
                    'ht': this.patientData.heightString,
                    'wt': this.patientData.weight,
                    'stature': this.patientData.heightString,
                    'mass': this.patientData.weight,
                    'body_weight': this.patientData.weight,
                    'patient_weight': this.patientData.weight,
                    'patient_height': this.patientData.heightString,
                    'birthday': this.patientData.birthdayFormatted,
                    'birth_day': this.patientData.birthdayFormatted,
                    'years_old': this.patientData.age,
                    'yrs': this.patientData.age,
                    'years': this.patientData.age,
                    'body_mass_index': this.patientData.bmi,
                    'mass_index': this.patientData.bmi,
                    'bm_index': this.patientData.bmi,
                    'nutritional_assessment_height': this.patientData.heightString,
                    'nutritional_assessment_weight': this.patientData.weight
                }
            };

            const formMappings = fieldMappings[this.selectedForm] || {};
            
            // Simple matching: try exact match first, then case-insensitive, then partial
            allFieldNames.forEach(fieldName => {
                const fieldNameLower = fieldName.toLowerCase();
                
                // Try exact match first
                if (formMappings[fieldName] && formMappings[fieldName] !== '') {
                    mappings[fieldName] = formMappings[fieldName];
                    console.log(`✅ Exact match: ${fieldName} → ${formMappings[fieldName]}`);
                    return;
                }
                
                // Try case-insensitive match
                Object.entries(formMappings).forEach(([pattern, value]) => {
                    if (value && value !== '' && fieldNameLower === pattern.toLowerCase()) {
                        mappings[fieldName] = value;
                        console.log(`✅ Case-insensitive match: ${fieldName} → ${value}`);
                        return;
                    }
                });
                
                // Try partial match if no exact match found
                if (!mappings[fieldName]) {
                    Object.entries(formMappings).forEach(([pattern, value]) => {
                        if (value && value !== '' && 
                            (fieldNameLower.includes(pattern.toLowerCase()) || 
                             pattern.toLowerCase().includes(fieldNameLower))) {
                            mappings[fieldName] = value;
                            console.log(`✅ Partial match: ${fieldName} → ${value}`);
                            return;
                        }
                    });
                }
            });

            // Add specific mappings for the exact field names we know exist
            if (this.selectedForm === 'health-exam') {
                // Health Exam Form specific exact mappings
                if (allFieldNames.includes('Name') && this.patientData.fullName) {
                    mappings['Name'] = this.patientData.fullName;
                    console.log(`✅ Direct mapping: Name → ${this.patientData.fullName}`);
                }
                if (allFieldNames.includes('DOB') && this.patientData.birthdayFormatted) {
                    mappings['DOB'] = this.patientData.birthdayFormatted;
                    console.log(`✅ Direct mapping: DOB → ${this.patientData.birthdayFormatted}`);
                }
                if (allFieldNames.includes('Height') && this.patientData.heightString) {
                    mappings['Height'] = this.patientData.heightString;
                    console.log(`✅ Direct mapping: Height → ${this.patientData.heightString}`);
                }
                if (allFieldNames.includes('Weight') && this.patientData.weight) {
                    mappings['Weight'] = this.patientData.weight;
                    console.log(`✅ Direct mapping: Weight → ${this.patientData.weight}`);
                }
                if (allFieldNames.includes('BMI') && this.patientData.bmi) {
                    mappings['BMI'] = this.patientData.bmi;
                    console.log(`✅ Direct mapping: BMI → ${this.patientData.bmi}`);
                }
            }

            console.log(`Sample Form Field Mappings for ${this.selectedForm}:`, mappings);
            console.log(`Total fields found: ${allFieldNames.length}`);
            console.log(`Fields mapped: ${Object.keys(mappings).length}`);
            
            return mappings;
        }

        async fillPDFFieldsAdvanced(form, mappings) {
            let filledCount = 0;
            const errors = [];

            console.log('🔍 Starting PDF field filling process...');
            console.log('📋 Mappings to apply:', mappings);
            console.log('📄 Form type:', this.selectedForm);

            // Try to embed a default font to fix appearance issues
            try {
                const pdfDoc = form.getDocument();
                const helveticaFont = await pdfDoc.embedFont('Helvetica');
                console.log('✅ Embedded Helvetica font for field appearances');
            } catch (e) {
                console.warn('⚠️ Could not embed font, will try alternative approach:', e.message);
            }

            // Process fields sequentially to handle async operations properly
            for (const [fieldName, value] of Object.entries(mappings)) {
                if (value && value !== '') {
                    try {
                        const field = form.getField(fieldName);
                        const fieldType = field.constructor.name;
                        const isReadOnly = field.isReadOnly();
                        
                        console.log(`Filling field: ${fieldName} (${fieldType}) with value: ${value}, ReadOnly: ${isReadOnly}`);
                        
                        // Skip read-only fields
                        if (isReadOnly) {
                            console.warn(`⚠️ Skipping read-only field: ${fieldName}`);
                            continue;
                        }
                        
                        // Try multiple methods to fill the field
                        let filled = false;
                        
                        // Method 1: Try setText (for text fields)
                        if (!filled && typeof field.setText === 'function') {
                            try {
                                console.log(`🔄 Attempting to fill ${fieldName} with "${value}" using setText()`);
                                field.setText(String(value));
                                filledCount++;
                                filled = true;
                                console.log(`✅ Successfully filled text field: ${fieldName} using setText()`);
                            } catch (e) {
                                console.warn(`❌ setText failed for ${fieldName}:`, e.message);
                            }
                        }
                        
                        // Method 2: Try setValue (alternative method)
                        if (!filled && typeof field.setValue === 'function') {
                            try {
                                field.setValue(String(value));
                                filledCount++;
                                filled = true;
                                console.log(`✅ Successfully filled field: ${fieldName} using setValue()`);
                            } catch (e) {
                                console.warn(`❌ setValue failed for ${fieldName}:`, e.message);
                            }
                        }
                        
                        // Method 3: Handle dropdown fields
                        if (!filled && typeof field.getOptions === 'function') {
                            try {
                                const options = field.getOptions();
                                console.log(`Dropdown options for ${fieldName}:`, options);
                                
                                // Try exact match first
                                if (options.includes(String(value))) {
                                    field.select(String(value));
                                    filledCount++;
                                    filled = true;
                                    console.log(`✅ Successfully selected dropdown value: ${fieldName} = ${value}`);
                                } else {
                                    // Try case-insensitive match
                                    const matchingOption = options.find(option => 
                                        option.toLowerCase() === String(value).toLowerCase()
                                    );
                                    if (matchingOption) {
                                        field.select(matchingOption);
                                        filledCount++;
                                        filled = true;
                                        console.log(`✅ Successfully selected dropdown value (case-insensitive): ${fieldName} = ${matchingOption}`);
                                    } else {
                                        console.warn(`⚠️ No matching dropdown option found for ${fieldName} with value: ${value}`);
                                    }
                                }
                            } catch (e) {
                                console.warn(`❌ Could not select dropdown value for ${fieldName}:`, e);
                                errors.push(`Dropdown error for ${fieldName}: ${e.message}`);
                            }
                        }
                        
                        // Method 4: Handle checkbox fields
                        if (!filled && typeof field.check === 'function') {
                            try {
                                if (value && value !== '0' && value !== 'false' && value !== 'no') {
                                    field.check();
                                    filledCount++;
                                    filled = true;
                                    console.log(`✅ Successfully checked checkbox: ${fieldName}`);
                                } else {
                                    field.uncheck();
                                    filledCount++;
                                    filled = true;
                                    console.log(`✅ Successfully unchecked checkbox: ${fieldName}`);
                                }
                            } catch (e) {
                                console.warn(`❌ Could not set checkbox for ${fieldName}:`, e);
                                errors.push(`Checkbox error for ${fieldName}: ${e.message}`);
                            }
                        }
                        
                        // Method 5: Handle radio button groups
                        if (!filled && typeof field.select === 'function' && fieldType.includes('Radio')) {
                            try {
                                const options = field.getOptions();
                                console.log(`Radio options for ${fieldName}:`, options);
                                
                                // Try exact match first
                                if (options.includes(String(value))) {
                                    field.select(String(value));
                                    filledCount++;
                                    filled = true;
                                    console.log(`✅ Successfully selected radio value: ${fieldName} = ${value}`);
                                } else {
                                    // Try case-insensitive match
                                    const matchingOption = options.find(option => 
                                        option.toLowerCase() === String(value).toLowerCase()
                                    );
                                    if (matchingOption) {
                                        field.select(matchingOption);
                                        filledCount++;
                                        filled = true;
                                        console.log(`✅ Successfully selected radio value (case-insensitive): ${fieldName} = ${matchingOption}`);
                                    } else {
                                        console.warn(`⚠️ No matching radio option found for ${fieldName} with value: ${value}`);
                                    }
                                }
                            } catch (e) {
                                console.warn(`❌ Could not select radio value for ${fieldName}:`, e);
                                errors.push(`Radio error for ${fieldName}: ${e.message}`);
                            }
                        }
                        
                        // Method 6: Try to update appearances after filling (with font handling)
                        if (filled && typeof field.updateAppearances === 'function') {
                            try {
                                // Try to update with a default font
                                const pdfDoc = form.getDocument();
                                const helveticaFont = await pdfDoc.embedFont('Helvetica');
                                field.updateAppearances(helveticaFont);
                                console.log(`✅ Updated appearances for: ${fieldName} with font`);
                            } catch (e) {
                                try {
                                    // Fallback: try without font
                                    field.updateAppearances();
                                    console.log(`✅ Updated appearances for: ${fieldName} (fallback)`);
                                } catch (e2) {
                                    console.warn(`⚠️ Could not update appearances for ${fieldName}:`, e2.message);
                                }
                            }
                        }
                        
                        if (!filled) {
                            console.warn(`⚠️ Could not fill field ${fieldName} (${fieldType}) - no suitable method found`);
                            errors.push(`No suitable filling method for ${fieldName} (${fieldType})`);
                        }
                        
                    } catch (error) {
                        console.warn(`❌ Could not access field ${fieldName}:`, error);
                        errors.push(`Field access error for ${fieldName}: ${error.message}`);
                    }
                }
            }

            if (errors.length > 0) {
                console.warn(`⚠️ Field filling errors:`, errors);
            }

            console.log(`📊 Field filling summary: ${filledCount} fields filled successfully`);
            console.log(`📄 Form type: ${this.selectedForm}`);
            console.log(`📋 Total mappings attempted: ${Object.keys(mappings).length}`);
            
            // Force update all field appearances with font handling
            try {
                const pdfDoc = form.getDocument();
                const helveticaFont = await pdfDoc.embedFont('Helvetica');
                form.updateFieldAppearances(helveticaFont);
                console.log(`✅ Updated all field appearances with font`);
            } catch (e) {
                try {
                    // Fallback: try without font
                    form.updateFieldAppearances();
                    console.log(`✅ Updated all field appearances (fallback)`);
                } catch (e2) {
                    console.warn(`⚠️ Could not update all field appearances:`, e2.message);
                }
            }
            
            return filledCount;
        }

        downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            
            // Add download animation
            link.classList.add('download-animation');
            
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 1000);
        }

        addSuccessAnimation() {
            const processSection = document.getElementById('processSection');
            processSection.classList.add('success-animation');
            setTimeout(() => {
                processSection.classList.remove('success-animation');
            }, 800);
        }

        updateStats(success, processingTime) {
            this.stats.formsProcessed++;
            this.stats.totalProcessingTime += processingTime;
            if (success) this.stats.successCount++;
            
            this.saveStats();
            this.updateStatsDisplay();
            
            // Show stats section after first processing
            document.getElementById('statsSection').style.display = 'block';
        }

        updateStatsDisplay() {
            const avgTime = this.stats.formsProcessed > 0 ? 
                (this.stats.totalProcessingTime / this.stats.formsProcessed / 1000).toFixed(1) : '0';
            const successRate = this.stats.formsProcessed > 0 ? 
                Math.round((this.stats.successCount / this.stats.formsProcessed) * 100) : 0;

            document.getElementById('formsProcessed').textContent = this.stats.formsProcessed;
            document.getElementById('fieldsMapped').textContent = this.stats.fieldsMapped;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('avgTime').textContent = avgTime + 's';
        }

        saveStats() {
            try {
                // Note: In a real implementation, you might save to localStorage
                // But for this demo, we keep stats in memory only
            } catch (error) {
                console.warn('Could not save statistics');
            }
        }

        loadStats() {
            try {
                // Note: In a real implementation, you might load from localStorage
                this.updateStatsDisplay();
            } catch (error) {
                console.warn('Could not load statistics');
            }
        }

        handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + Enter to process form
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const processBtn = document.getElementById('processBtn');
                if (!processBtn.disabled) {
                    this.processForm();
                }
            }
            
            // Ctrl/Cmd + 1-3 for quick patient selection
            if ((e.ctrlKey || e.metaKey) && ['1', '2', '3', '4'].includes(e.key)) {
                e.preventDefault();
                const patients = ['steve', 'joe', 'jane', 'random'];
                this.quickFill(patients[parseInt(e.key) - 1]);
            }
        }

        showAllFieldNames() {
            if (!this.pdfDoc) {
                this.updateStatus('No PDF loaded. Please select a form first.', 'error');
                return;
            }

            try {
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                const fieldList = document.getElementById('fieldList');
                
                let debugText = `ALL FIELD NAMES IN PDF\n`;
                debugText += `=====================\n\n`;
                debugText += `📋 FORM: ${this.getFormDisplayName()}\n`;
                debugText += `📊 TOTAL FIELDS: ${fields.length}\n\n`;
                
                debugText += `🔍 FIELD DETAILS:\n`;
                debugText += `================\n`;
                
                fields.forEach((field, index) => {
                    const fieldName = field.getName();
                    const fieldType = field.constructor.name;
                    const fieldTypeShort = fieldType.replace('PDFField', '').replace('PDF', '');
                    
                    debugText += `${index + 1}. ${fieldName}\n`;
                    debugText += `   Type: ${fieldTypeShort}\n`;
                    
                    // Show additional info for specific field types
                    if (fieldType.includes('Dropdown') || fieldType.includes('RadioGroup')) {
                        try {
                            const options = field.getOptions();
                            debugText += `   Options: [${options.join(', ')}]\n`;
                        } catch (e) {
                            debugText += `   Options: Error getting options\n`;
                        }
                    }
                    
                    debugText += `\n`;
                });
                
                debugText += `💡 TIPS:\n`;
                debugText += `- Use these exact field names for precise mapping\n`;
                debugText += `- Field names are case-sensitive\n`;
                debugText += `- Some fields might be read-only or hidden\n`;
                
                fieldList.textContent = debugText;
                document.getElementById('debugSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error showing field names:', error);
                this.updateStatus('Error displaying field names', 'error');
            }
        }

        normalizeFieldName(fieldName) {
            // Remove common prefixes and suffixes
            let normalized = fieldName
                .replace(/^(form|field|input|text|txt)_/i, '')
                .replace(/_(form|field|input|text|txt)$/i, '')
                .replace(/^(patient|client|participant)_/i, '')
                .replace(/_(patient|client|participant)$/i, '');
            
            // Convert to lowercase and replace spaces/underscores with single space
            normalized = normalized.toLowerCase()
                .replace(/[_\s]+/g, ' ')
                .trim();
            
            // Remove common words that don't add meaning
            normalized = normalized
                .replace(/\b(form|field|input|text|txt|box|area)\b/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            return normalized;
        }

        createCustomMappings() {
            if (!this.pdfDoc) {
                this.updateStatus('No PDF loaded. Please select a form first.', 'error');
                return;
            }

            try {
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                const fieldList = document.getElementById('fieldList');
                
                let debugText = `CUSTOM FIELD MAPPINGS\n`;
                debugText += `====================\n\n`;
                debugText += `📋 FORM: ${this.getFormDisplayName()}\n`;
                debugText += `📊 TOTAL FIELDS: ${fields.length}\n\n`;
                
                debugText += `🔧 SUGGESTED MAPPINGS:\n`;
                debugText += `====================\n`;
                
                // Create suggested mappings based on field names
                const suggestedMappings = {};
                
                fields.forEach((field, index) => {
                    const fieldName = field.getName();
                    const fieldType = field.constructor.name;
                    const fieldNameLower = fieldName.toLowerCase();
                    
                    // Suggest mappings based on field name patterns
                    let suggestedMapping = 'unmapped';
                    let suggestedValue = '';
                    
                    if (fieldNameLower.includes('first') || fieldNameLower.includes('fname') || fieldNameLower.includes('given')) {
                        suggestedMapping = 'firstName';
                        suggestedValue = this.patientData.firstName || 'John';
                    } else if (fieldNameLower.includes('last') || fieldNameLower.includes('lname') || fieldNameLower.includes('surname') || fieldNameLower.includes('family')) {
                        suggestedMapping = 'lastName';
                        suggestedValue = this.patientData.lastName || 'Doe';
                    } else if (fieldNameLower.includes('name') && !fieldNameLower.includes('first') && !fieldNameLower.includes('last')) {
                        suggestedMapping = 'fullName';
                        suggestedValue = this.patientData.fullName || 'John Doe';
                    } else if (fieldNameLower.includes('height') || fieldNameLower.includes('ht') || fieldNameLower.includes('stature')) {
                        suggestedMapping = 'height';
                        suggestedValue = this.patientData.heightString || '5\'10"';
                    } else if (fieldNameLower.includes('weight') || fieldNameLower.includes('wt') || fieldNameLower.includes('mass')) {
                        suggestedMapping = 'weight';
                        suggestedValue = this.patientData.weight || '150';
                    } else if (fieldNameLower.includes('birth') || fieldNameLower.includes('dob') || fieldNameLower.includes('date')) {
                        suggestedMapping = 'birthday';
                        suggestedValue = this.patientData.birthdayFormatted || '01/01/1990';
                    } else if (fieldNameLower.includes('age') || fieldNameLower.includes('years')) {
                        suggestedMapping = 'age';
                        suggestedValue = this.patientData.age || '30';
                    } else if (fieldNameLower.includes('bmi')) {
                        suggestedMapping = 'bmi';
                        suggestedValue = this.patientData.bmi || '21.5';
                    }
                    
                    suggestedMappings[fieldName] = { mapping: suggestedMapping, value: suggestedValue };
                    
                    const indicator = suggestedMapping !== 'unmapped' ? '✅' : '❌';
                    debugText += `${indicator} ${index + 1}. ${fieldName}\n`;
                    debugText += `   Type: ${fieldType.replace('PDFField', '').replace('PDF', '')}\n`;
                    debugText += `   Suggested: ${suggestedMapping} → ${suggestedValue}\n\n`;
                });
                
                debugText += `💡 CUSTOM MAPPING CODE:\n`;
                debugText += `======================\n`;
                debugText += `// Add this to createSampleFormFieldMappings() function:\n`;
                debugText += `const customMappings = {\n`;
                
                Object.entries(suggestedMappings).forEach(([fieldName, mapping]) => {
                    if (mapping.mapping !== 'unmapped') {
                        debugText += `    '${fieldName}': this.patientData.${mapping.mapping},\n`;
                    }
                });
                
                debugText += `};\n`;
                debugText += `Object.assign(mappings, customMappings);\n`;
                
                fieldList.textContent = debugText;
                document.getElementById('debugSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error creating custom mappings:', error);
                this.updateStatus('Error creating custom mappings', 'error');
            }
        }

        debugFieldMapping() {
            if (!this.pdfDoc) {
                this.updateStatus('No PDF loaded. Please select a form first.', 'error');
                return;
            }

            try {
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                const fieldList = document.getElementById('fieldList');
                
                let debugText = `FIELD MAPPING DEBUG\n`;
                debugText += `==================\n\n`;
                debugText += `📋 FORM: ${this.getFormDisplayName()}\n`;
                debugText += `📊 TOTAL FIELDS: ${fields.length}\n\n`;
                
                // Test the field mapping function
                const mappings = this.createSampleFormFieldMappings(fields);
                
                debugText += `🔍 FIELD MAPPING RESULTS:\n`;
                debugText += `========================\n`;
                
                fields.forEach((field, index) => {
                    const fieldName = field.getName();
                    const fieldType = field.constructor.name;
                    const isMapped = mappings[fieldName];
                    
                    const indicator = isMapped ? '✅' : '❌';
                    debugText += `${indicator} ${index + 1}. ${fieldName}\n`;
                    debugText += `   Type: ${fieldType.replace('PDFField', '').replace('PDF', '')}\n`;
                    debugText += `   Mapped: ${isMapped ? `Yes → ${isMapped}` : 'No'}\n\n`;
                });
                
                debugText += `📈 SUMMARY:\n`;
                debugText += `===========\n`;
                debugText += `Total Fields: ${fields.length}\n`;
                debugText += `Mapped Fields: ${Object.keys(mappings).length}\n`;
                debugText += `Mapping Success Rate: ${Math.round((Object.keys(mappings).length / fields.length) * 100)}%\n\n`;
                
                debugText += `💡 PATIENT DATA:\n`;
                debugText += `===============\n`;
                debugText += `First Name: ${this.patientData.firstName || 'Not set'}\n`;
                debugText += `Last Name: ${this.patientData.lastName || 'Not set'}\n`;
                debugText += `Full Name: ${this.patientData.fullName || 'Not set'}\n`;
                debugText += `Height: ${this.patientData.heightString || 'Not set'}\n`;
                debugText += `Weight: ${this.patientData.weight || 'Not set'}\n`;
                debugText += `Birthday: ${this.patientData.birthdayFormatted || 'Not set'}\n`;
                debugText += `Age: ${this.patientData.age || 'Not set'}\n`;
                debugText += `BMI: ${this.patientData.bmi || 'Not set'}\n`;
                
                fieldList.textContent = debugText;
                document.getElementById('debugSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error debugging field mapping:', error);
                this.updateStatus('Error debugging field mapping', 'error');
            }
        }

        testFieldFilling() {
            if (!this.pdfDoc) {
                this.updateStatus('No PDF loaded. Please select a form first.', 'error');
                return;
            }

            try {
                const form = this.pdfDoc.getForm();
                const fields = form.getFields();
                const fieldList = document.getElementById('fieldList');
                
                let debugText = `FIELD FILLING TEST\n`;
                debugText += `==================\n\n`;
                debugText += `📋 FORM: ${this.getFormDisplayName()}\n`;
                debugText += `📊 TOTAL FIELDS: ${fields.length}\n\n`;
                
                // Test the field mapping function
                const mappings = this.createSampleFormFieldMappings(fields);
                
                debugText += `🔍 FIELD FILLING RESULTS:\n`;
                debugText += `========================\n`;
                
                let filledCount = 0;
                let errorCount = 0;
                
                Object.entries(mappings).forEach(([fieldName, value]) => {
                    try {
                        const field = form.getField(fieldName);
                        const fieldType = field.constructor.name;
                        
                        debugText += `Testing: ${fieldName} (${fieldType}) → ${value}\n`;
                        
                        if (fieldType.includes('Text')) {
                            field.setText(String(value));
                            debugText += `   ✅ Text field filled successfully\n`;
                            filledCount++;
                        } else if (fieldType.includes('Dropdown')) {
                            try {
                                field.select(String(value));
                                debugText += `   ✅ Dropdown field filled successfully\n`;
                                filledCount++;
                            } catch (e) {
                                debugText += `   ❌ Dropdown error: ${e.message}\n`;
                                errorCount++;
                            }
                        } else if (fieldType.includes('CheckBox')) {
                            if (value && value !== '0' && value !== 'false') {
                                field.check();
                                debugText += `   ✅ Checkbox checked successfully\n`;
                                filledCount++;
                            } else {
                                field.uncheck();
                                debugText += `   ✅ Checkbox unchecked successfully\n`;
                                filledCount++;
                            }
                        } else {
                            debugText += `   ⚠️ Unsupported field type: ${fieldType}\n`;
                        }
                    } catch (error) {
                        debugText += `   ❌ Error filling field: ${error.message}\n`;
                        errorCount++;
                    }
                    debugText += `\n`;
                });
                
                debugText += `📈 SUMMARY:\n`;
                debugText += `===========\n`;
                debugText += `Total Mapped Fields: ${Object.keys(mappings).length}\n`;
                debugText += `Successfully Filled: ${filledCount}\n`;
                debugText += `Errors: ${errorCount}\n`;
                debugText += `Success Rate: ${Math.round((filledCount / Object.keys(mappings).length) * 100)}%\n\n`;
                
                debugText += `💡 PATIENT DATA:\n`;
                debugText += `===============\n`;
                debugText += `First Name: ${this.patientData.firstName || 'Not set'}\n`;
                debugText += `Last Name: ${this.patientData.lastName || 'Not set'}\n`;
                debugText += `Full Name: ${this.patientData.fullName || 'Not set'}\n`;
                debugText += `Height: ${this.patientData.heightString || 'Not set'}\n`;
                debugText += `Weight: ${this.patientData.weight || 'Not set'}\n`;
                debugText += `Birthday: ${this.patientData.birthdayFormatted || 'Not set'}\n`;
                debugText += `Age: ${this.patientData.age || 'Not set'}\n`;
                debugText += `BMI: ${this.patientData.bmi || 'Not set'}\n`;
                
                fieldList.textContent = debugText;
                document.getElementById('debugSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error testing field filling:', error);
                this.updateStatus('Error testing field filling', 'error');
            }
        }

        updateStatus(message, type = '') {
            const statusSection = document.getElementById('statusSection');
            const statusText = document.getElementById('statusText');
            const statusIcon = statusSection.querySelector('.status-icon');
            
            statusText.textContent = message;
            
            // Remove existing status classes
            statusSection.className = 'status-section';
            statusSection.classList.add(`status-${type}`);

            // Update icon based on status
            const icons = {
                ready: 'fas fa-info-circle',
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                processing: 'fas fa-spinner fa-spin'
            };
            
            if (statusIcon) {
                statusIcon.className = 'status-icon ' + (icons[type] || icons.ready);
            }

            // Auto-clear success messages
            if (type === 'success') {
                setTimeout(() => {
                    if (statusSection.classList.contains('status-success')) {
                        this.updateStatus('Ready to process more forms', 'ready');
                    }
                }, 5000);
            }
        }

        async createFillableWICForm() {
            try {
                // Create a new PDF document
                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([612, 792]); // Standard letter size
                
                // Embed fonts
                const helveticaFont = await pdfDoc.embedFont('Helvetica');
                const helveticaBold = await pdfDoc.embedFont('Helvetica-Bold');
                
                // Define colors
                const black = PDFLib.rgb(0, 0, 0);
                const darkBlue = PDFLib.rgb(0.2, 0.4, 0.8);
                const lightGray = PDFLib.rgb(0.95, 0.95, 0.95);
                
                // Add title
                page.drawText('WIC Nutritional Assessment Form', {
                    x: 50,
                    y: 750,
                    size: 20,
                    font: helveticaBold,
                    color: darkBlue
                });
                
                // Add subtitle
                page.drawText('Women, Infants, and Children Program', {
                    x: 50,
                    y: 720,
                    size: 12,
                    font: helveticaFont,
                    color: black
                });
                
                // Add form fields
                const formFields = [
                    { name: 'participant_name', label: 'Participant Name:', x: 50, y: 650, width: 200, height: 20 },
                    { name: 'date_of_birth', label: 'Date of Birth:', x: 50, y: 600, width: 150, height: 20 },
                    { name: 'age', label: 'Age:', x: 250, y: 600, width: 80, height: 20 },
                    { name: 'height', label: 'Height:', x: 50, y: 550, width: 120, height: 20 },
                    { name: 'weight', label: 'Weight:', x: 200, y: 550, width: 120, height: 20 },
                    { name: 'bmi', label: 'BMI:', x: 350, y: 550, width: 80, height: 20 },
                    { name: 'contact_info', label: 'Contact Information:', x: 50, y: 500, width: 300, height: 20 },
                    { name: 'emergency_contact', label: 'Emergency Contact:', x: 50, y: 450, width: 300, height: 20 },
                    { name: 'assessment_date', label: 'Assessment Date:', x: 50, y: 400, width: 150, height: 20 }
                ];
                
                // Draw labels and create form fields
                formFields.forEach(field => {
                    // Draw label
                    page.drawText(field.label, {
                        x: field.x,
                        y: field.y + 15,
                        size: 10,
                        font: helveticaBold,
                        color: black
                    });
                    
                    // Create text field
                    const textField = pdfDoc.getForm().createTextField(field.name);
                    textField.addToPage(page, {
                        x: field.x,
                        y: field.y,
                        width: field.width,
                        height: field.height,
                        borderWidth: 1,
                        borderColor: black,
                        backgroundColor: lightGray,
                        fontSize: 10,
                        font: helveticaFont
                    });
                });
                
                // Add additional sections
                page.drawText('Nutritional Assessment', {
                    x: 50,
                    y: 350,
                    size: 14,
                    font: helveticaBold,
                    color: darkBlue
                });
                
                // Add checkboxes for nutritional status
                const checkboxes = [
                    { name: 'nutritional_risk', label: 'Nutritional Risk Identified', x: 50, y: 320 },
                    { name: 'pregnancy', label: 'Pregnant', x: 50, y: 290 },
                    { name: 'breastfeeding', label: 'Breastfeeding', x: 50, y: 260 },
                    { name: 'postpartum', label: 'Postpartum', x: 50, y: 230 }
                ];
                
                checkboxes.forEach(checkbox => {
                    // Draw label
                    page.drawText(checkbox.label, {
                        x: checkbox.x + 20,
                        y: checkbox.y + 5,
                        size: 10,
                        font: helveticaFont,
                        color: black
                    });
                    
                    // Create checkbox
                    const checkboxField = pdfDoc.getForm().createCheckBox(checkbox.name);
                    checkboxField.addToPage(page, {
                        x: checkbox.x,
                        y: checkbox.y,
                        width: 15,
                        height: 15,
                        borderWidth: 1,
                        borderColor: black
                    });
                });
                
                // Add signature field
                page.drawText('Healthcare Provider Signature:', {
                    x: 50,
                    y: 180,
                    size: 10,
                    font: helveticaBold,
                    color: black
                });
                
                const signatureField = pdfDoc.getForm().createTextField('provider_signature');
                signatureField.addToPage(page, {
                    x: 50,
                    y: 150,
                    width: 200,
                    height: 30,
                    borderWidth: 1,
                    borderColor: black,
                    backgroundColor: lightGray,
                    fontSize: 10,
                    font: helveticaFont
                });
                
                // Add date field
                page.drawText('Date:', {
                    x: 300,
                    y: 180,
                    size: 10,
                    font: helveticaBold,
                    color: black
                });
                
                const dateField = pdfDoc.getForm().createTextField('signature_date');
                dateField.addToPage(page, {
                    x: 300,
                    y: 150,
                    width: 100,
                    height: 20,
                    borderWidth: 1,
                    borderColor: black,
                    backgroundColor: lightGray,
                    fontSize: 10,
                    font: helveticaFont
                });
                
                // Save the PDF and replace the current WIC Form
                const pdfBytes = await pdfDoc.save();
                
                // Create a blob and download it
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'wicform.pdf';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Update the current PDF document
                this.pdfDoc = pdfDoc;
                
                // Analyze the new form
                const form = this.pdfDoc.getForm();
                const pdfFields = form.getFields();
                const analysis = this.performFieldAnalysis(pdfFields);
                
                // Show debug info
                this.showAdvancedDebugInfo(pdfFields, analysis);
                
                // Update confidence score
                document.getElementById('confidenceDisplay').textContent = analysis.confidence + '%';
                
                this.updateStatus('✅ Fillable WIC Form created and loaded! The form is now ready for auto-filling. A copy has been downloaded as "wicform.pdf" for your reference.', 'success');
                
                this.updateProcessSection();
                this.checkReadyToProcess();
                
            } catch (error) {
                console.error('Error creating fillable WIC Form:', error);
                this.updateStatus(`❌ Error creating fillable WIC Form: ${error.message}`, 'error');
            }
        }
    }

    // Initialize the advanced system
    document.addEventListener('DOMContentLoaded', () => {
        window.advancedAutofillSystem = new AdvancedPatientFormAutofill();
    });

    // Enhanced utility functions
    window.testFunctions = {
        fillPatientData: (data) => {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = data[key];
            });
            window.advancedAutofillSystem.updatePatientData();
        },
        
        getCurrentPatientData: () => {
            return window.advancedAutofillSystem.patientData;
        },
        
        getStats: () => {
            return window.advancedAutofillSystem.stats;
        },
        
        simulateRandomPatients: (count = 5) => {
            console.log(`Generating ${count} random patients for testing...`);
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    window.advancedAutofillSystem.quickFill('random');
                }, i * 1000);
            }
        }
    };

    // Add helpful console messages
    console.log('%c🏥 Advanced Patient Form Autofill System Loaded! 🏥', 'color: #27ae60; font-size: 16px; font-weight: bold;');
    console.log('%cKeyboard Shortcuts:', 'color: #3498db; font-weight: bold;');
    console.log('• Ctrl/Cmd + Enter: Process form');
    console.log('• Ctrl/Cmd + 1-4: Quick fill patients (Steve, Joe, Jane, Random)');
    console.log('%cTest Functions:', 'color: #e74c3c; font-weight: bold;');
    console.log('• testFunctions.fillPatientData(data)');
    console.log('• testFunctions.getCurrentPatientData()');
    console.log('• testFunctions.getStats()');
    console.log('• testFunctions.simulateRandomPatients(5)');
</script>
</body>
</html>="health-exam">
                                <i class="fas fa-stethoscope form-card-icon"></i>
                                <div class="form-card-title">Health Exam Form</div>
                                <div class="form-card-description">Comprehensive medical examination form with vital signs and health metrics</div>
                            </div>
                            <div class="sample-form-card" data-form="wic">
                                <i class="fas fa-baby form-card-icon"></i>
                                <div class="form-card-title">WIC Form</div>
                                <div class="form-card-description">Women, Infants, and Children nutritional assistance program form</div>
                            </div>
                            <div class="sample-form-card" data-form